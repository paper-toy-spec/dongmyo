/* ---------- ALLEY ---------- */
function alley(){
  state.scene='alley';
  
  // ì£¼í™”ê°€ 0ì¼ ë•Œ ê³ ë¦¬ëŒ€ê¸ˆì—…ì ë“±ì¥ í™•ë¥  ë†’ì„
  if (state.res.coins === 0 && Math.random() < 0.7) {
    return loanShark();
  }
  
  const roll = Math.random();
  if (roll<0.34) return npcEncounter();
  if (roll<0.67) return lightFight();
  return gambling();
}

// ê³ ë¦¬ëŒ€ê¸ˆì—…ì ì´ë²¤íŠ¸
function loanShark(){
  setText(`ì–´ë‘  ì†ì—ì„œ ëˆ„êµ°ê°€ ë‹¤ê°€ì˜¨ë‹¤.
  
"ì£¼í™”ê°€ ë–¨ì–´ì§„ ê²ƒ ê°™ì€ë°... ë¹Œë ¤ì¤„ê¹Œ?"

ê²€ì€ ë‘ê±´ì˜ ì‚¬ë‚´ê°€ ì›ƒëŠ”ë‹¤.
ì´ë¹¨ì´ ê¸ˆìœ¼ë¡œ ë˜ì–´ìˆë‹¤.

"ì´ìëŠ”... ë„¤ ì •ì‹ ë ¥ì´ì•¼."
(ì£¼í™” +3, ë§¤ í„´ ì •ì‹  -2)`);
  
  const ch = [];
  
  // ë¹Œë¦¬ê¸° ì˜µì…˜
  if (!state.flags.hasLoan) {
    ch.push({text:`ì£¼í™” 3ê°œë¥¼ ë¹Œë¦°ë‹¤ (ë§¤ í„´ ì •ì‹  -2)`, fn:()=>{
      state.res.coins += 3;
      state.flags.hasLoan = true;
      state.flags.loanTurns = 0;
      showFloatMsg('ì£¼í™” +3 (ë¹š)');
      msg('ì°¨ê°€ìš´ ì£¼í™” 3ê°œê°€ ì†ì— ì¥ì–´ì¡Œë‹¤. "ìŠì§€ ë§ˆ. ë§¤ ìˆœê°„ ë„¤ ì •ì‹ ì„ ê°€ì ¸ê°ˆ ê±°ì•¼."');
      updateHUD();
      openMarket();
    }});
  }
  
  // ì´ë¯¸ ë¹šì´ ìˆìœ¼ë©´ ê°šê¸° ì˜µì…˜
  if (state.flags.hasLoan && state.res.coins >= 5) {
    ch.push({text:`ë¹šì„ ê°šëŠ”ë‹¤ (ì£¼í™” -5)`, fn:()=>{
      state.res.coins -= 5;
      state.flags.hasLoan = false;
      showFloatMsg('ë¹š ì²­ì‚°!');
      msg('ì‚¬ë‚´ê°€ ì£¼í™”ë¥¼ ë°›ì•„ ì„¸ì–´ë³¸ë‹¤. "í˜„ëª…í•œ ì„ íƒì´ì•¼."');
      updateHUD();
      openMarket();
    }});
  }
  
  // ëŒ€ì‹  ì œì•ˆ
  ch.push({text:`ê¸°ì–µì„ íŒë‹¤ (íŒíŠ¸ ì¡°ê° +2, ì •ì‹  -15)`, fn:()=>{
    addShard(2);
    losePsy(15);
    msg('ì†Œì¤‘í•œ ê¸°ì–µ í•˜ë‚˜ê°€ ì‚¬ë¼ì¡Œë‹¤. ëŒ€ì‹  ë¬´ì–¸ê°€ ì¤‘ìš”í•œ ê²ƒì„ ê¹¨ë‹¬ì•˜ë‹¤.');
    openMarket();
  }});
  
  ch.push({text:`ë„ë§ì¹œë‹¤ (ì‹œê°„ -5)`, fn:()=>{ 
    spend({time:5}); 
    msg('ê°„ì‹ íˆ ë„ë§ì³¤ë‹¤. í•˜ì§€ë§Œ ê·¸ëŠ” ë‹¤ì‹œ ë‚˜íƒ€ë‚  ê²ƒì´ë‹¤.');
    openMarket(); 
  }});
  
  setChoices(ch);
}

function npcEncounter(){
  setText(`ê³¨ëª©. ë“±ë¶ˆì´ ì—†ëŠ” ì–´ë‘  ì†ì—ì„œ ì†ì´ ë‚˜ì™€ ì†Œë§¤ë¥¼ ì¡ëŠ”ë‹¤.

"ì´ê±° ì°¾ëŠ” ê±° ì•„ë‹ˆì—ˆì–´?"`);
  
  // ì£¼í™”ê°€ 0ì¼ ë•Œ íŠ¹ë³„ ì˜µì…˜
  const ch = [];
  
  if (state.res.coins === 0) {
    ch.push({text:`"ì£¼í™”ê°€ í•„ìš”í•´..." (ì •ì‹  -10, ì£¼í™” +2)`, fn:()=>{
      losePsy(10);
      state.res.coins += 2;
      showFloatMsg('ì£¼í™” +2');
      msg('ë…¸íŒŒê°€ ì¸¡ì€í•œ ëˆˆìœ¼ë¡œ ë°”ë¼ë³¸ë‹¤. "ë¶ˆìŒí•œ ê²ƒ... ì´ê±¸ ê°€ì ¸ê°€ë ´. ëŒ€ì‹  ë„¤ í–‰ë³µí•œ ê¸°ì–µ í•˜ë‚˜ë¥¼ ì¤˜."');
      updateHUD();
      openMarket();
    }});
  }
  
  const base = baseChance('talk');
  const p = clamp(base + state.stats.empathy*6 - state.meta.heat*5, 10, 95);
  
  ch.push({text:`ì„¤ë“í•´ ë³¸ë‹¤ <span class="prob">ì„±ê³µ ${p}%</span>`, fn:()=>roll(p,
    ()=>{ 
      addShard(1); 
      gain('clues',1); 
      showFloatMsg('íŒíŠ¸ ì¡°ê° +1');
      msg('ë…¸íŒŒê°€ ë¹„ë‹¨ì£¼ë¨¸ë‹ˆë¥¼ ì¥ì—¬ì¤€ë‹¤. (íŒíŠ¸ ì¡°ê°+1, ë‹¨ì„œ+1)'); 
      openMarket(); 
    },
    ()=>{ 
      heatUp(1); 
      losePsy(6); 
      msg('"ê·¸ ëˆˆë¹›ì´ ì‹«ì–´." ì†ì´ ì‚¬ë¼ì¡Œë‹¤. (ì˜ì‹¬ë„+1, ì •ì‹ -6)'); 
      openMarket(); 
    }
  )});
  
  if (state.char !== 'ê´‘ê³ ì‚¬ì¥' && state.stats.empathy>=4) {
    ch.push({text:`ê´‘ê³ ì‚¬ì¥ì„ ë¶€ë¥¸ë‹¤ (ê°ì •â‰¥4, ì¿¨ 2í„´)`, fn:()=>callCompanion('ad', ()=>{ 
      addShard(1); 
      msg('"ë§ì€ ì´ë ‡ê²Œ ë‹¤ëŠ” ê±°ì•¼." ê´‘ê³ ì‚¬ì¥ì´ ëŠ¥ìˆ™í•˜ê²Œ ëŒ€í™”ë¥¼ ì´ëŒì—ˆë‹¤. (íŒíŠ¸ ì¡°ê°+1)'); 
      openMarket(); 
    })});
  }
  
  if (state.char !== 'ì œì„ìŠ¤') {
    ch.push({text:`ì œì„ìŠ¤ì—ê²Œ í˜‘ìƒì„ ë§¡ê¸´ë‹¤ (ì£¼í™” -1, ì¿¨ 2í„´)`, fn:()=>callCompanion('james', ()=>{ 
      gain('clues', 1);
      msg('"ì´ëŸ° ê±´ ë‚´ ì „ë¬¸ì´ì§€." ì œì„ìŠ¤ê°€ ëŠ¥ìˆ™í•˜ê²Œ êµì„­í–ˆë‹¤. (ë‹¨ì„œ+1)'); 
      openMarket(); 
    })});
  }
  
  ch.push({text:'ê·¸ëƒ¥ ì§€ë‚˜ì¹œë‹¤ (ì‹œê°„ -3)', fn:()=>{ spend({time:3}); openMarket(); }});
  setChoices(ch);
}/* ---------- ALLEY ---------- */
function alley(){
  state.scene='alley';
  
  // ì£¼í™”ê°€ ì—†ì„ ë•Œ íŠ¹ë³„ ì˜µì…˜
  if (state.res.coins === 0) {
    setText(`ê³¨ëª©. ì£¼ë¨¸ë‹ˆê°€<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>ë™ë¬˜ ê·€ì‹œì¥ Â· v1.1</title>
<style>
:root{
  --bg:#0b0b0c;--panel:#121213;--ink:#e8e0d8;--muted:#a89f96;--accent:#8b0000;--line:#2a2a2a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1100px circle at 50% -180px,#1a0000 0%,#0b0b0c 45%,#000 100%);
  color:var(--ink);font-family:"Noto Serif KR",Pretendard,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
.wrap{max-width:960px;margin:0 auto;padding:16px}
h1{margin:0 0 6px}
.btn, .choice{background:linear-gradient(180deg,#191919,#101010);border:1px solid #2b2b2b;color:var(--ink);
  padding:12px 14px;border-radius:10px;cursor:pointer;display:inline-block;
  -webkit-tap-highlight-color:transparent;
  user-select:none}
.btn:active,.choice:active{border-color:#922;background:linear-gradient(180deg,#3a0000,#260000)}
.title{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
.game-title{font-size:40px;color:#e35;text-shadow:0 0 26px rgba(139,0,0,.55)}
.intro{white-space:pre-wrap;color:var(--muted);line-height:1.85;max-width:760px;margin:12px auto 18px}
.panel{background:linear-gradient(180deg,#171717,#0e0e0f);border:1px solid var(--line);border-radius:12px;padding:16px}
.story{min-height:220px;white-space:pre-wrap;line-height:1.9;overflow-y:auto;max-height:50vh}
.choices{margin-top:12px;display:grid;gap:10px}
.hud{display:none}
.hud.on{display:block}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.h-title{font-weight:800;color:#e66}
.statbar{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin:10px 0}
.slab{background:linear-gradient(180deg,#171717,#101012);border:1px solid #2a2a2a;border-radius:10px;padding:8px 10px;text-align:center;font-size:13px}
.slab .v{display:block;font-weight:800;margin-top:4px}
.bad{color:#f59}
.good{color:#9ef0b0}
.warn{color:#f6d37a}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
.inv{margin-top:10px;padding:10px;border:1px dashed #333;border-radius:10px;display:none}
.inv.on{display:block}
.tag{background:#151515;border:1px solid #333;padding:4px 8px;border-radius:999px;font-size:12px;margin:2px}
.kv{font-size:12px;color:#b9b0a6}
hr.sep{border:none;border-top:1px solid #272727;margin:10px 0}
.help{position:fixed;right:0;top:0;bottom:0;width:380px;max-width:94vw;background:#111;border-left:1px solid #2a2a2a;transform:translateX(100%);transition:.25s;z-index:50;overflow-y:auto}
.help.on{transform:translateX(0)}
.help .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #2a2a2a}
.help .body{padding:12px;height:calc(100% - 52px);overflow:auto}
.small{font-size:12px;color:#9a8f85}
.prob{font-size:12px;color:#caa}
.tip{font-size:12px;color:#9ab1ff}
.notice{font-size:12px;color:#b7f59e}

/* íŠœí† ë¦¬ì–¼ ì „ìš© ìŠ¤íƒ€ì¼ */
.tutorial-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:100;display:none}
.tutorial-overlay.on{display:flex;align-items:center;justify-content:center}
.tutorial-box{background:var(--panel);border:2px solid var(--accent);border-radius:12px;padding:24px;max-width:500px;width:90%;animation:slideIn 0.3s}
@keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
.tutorial-title{font-size:20px;color:#e66;margin-bottom:12px;font-weight:800}
.tutorial-text{line-height:1.8;margin-bottom:20px;white-space:pre-wrap}
.tutorial-step{font-size:11px;color:#666;margin-top:12px}

/* í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
.highlight{animation:pulse 1s infinite;box-shadow:0 0 20px #e66!important}
@keyframes pulse{0%{opacity:1}50%{opacity:0.6}100%{opacity:1}}

/* ì§„í–‰ë„ ë°” */
.progress-container{margin:10px 0}
.progress-bar{height:6px;background:#222;border-radius:3px;position:relative;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#8b0000,#e66);border-radius:3px;transition:width 0.5s}
.progress-text{font-size:11px;color:#999;margin-top:4px;display:block}

/* íŒíŠ¸ ë©”ì‹œì§€ */
.hint-msg{background:rgba(139,0,0,0.2);border:1px solid rgba(139,0,0,0.5);border-radius:8px;padding:8px 12px;margin:8px 0;font-size:12px;animation:fadeIn 0.5s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* ì½”ì¸ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes coinChange {
  0% { transform: scale(1); }
  50% { transform: scale(1.5); color: #ff0; text-shadow: 0 0 10px #ff0; }
  100% { transform: scale(1); }
}
.coin-anim { animation: coinChange 0.5s; }

/* ë™í–‰ í‘œì‹œ */
.companions {
  display: flex;
  gap: 8px;
  margin: 8px 0;
  padding: 8px;
  background: rgba(0,0,0,0.3);
  border-radius: 8px;
}
.companion-card {
  padding: 6px 10px;
  background: linear-gradient(180deg, #1a1a1a, #0f0f0f);
  border: 1px solid #333;
  border-radius: 6px;
  font-size: 11px;
  text-align: center;
}
.companion-card.ready { border-color: #4a4; }
.companion-card.cooldown { opacity: 0.5; border-color: #666; }
.comp-name { font-weight: 600; color: #e8e0d8; }
.comp-skill { color: #999; font-size: 10px; margin-top: 2px; }
.comp-cd { color: #f66; font-size: 10px; }

/* ì¸ë²¤í† ë¦¬ ê°œì„  */
.inv-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 6px;
  margin-top: 8px;
}
.inv-item {
  background: linear-gradient(135deg, #1a1a1a, #0f0f0f);
  border: 1px solid #444;
  border-radius: 8px;
  padding: 8px;
  font-size: 11px;
  text-align: center;
  position: relative;
}
.inv-item:hover {
  border-color: #666;
  transform: translateY(-2px);
  transition: all 0.2s;
}
.item-icon {
  font-size: 20px;
  margin-bottom: 4px;
}

/* í”Œë¡œíŒ… ë©”ì‹œì§€ */
.float-msg {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(139,0,0,0.9);
  border: 2px solid #e66;
  border-radius: 12px;
  padding: 16px 24px;
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  z-index: 200;
  animation: floatUp 2s;
  pointer-events: none;
}
@keyframes floatUp {
  0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
  20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
  40% { transform: translate(-50%, -50%) scale(1); }
  100% { opacity: 0; transform: translate(-50%, -70%); }
}

@media (max-width:640px){
  .statbar{grid-template-columns:repeat(3,1fr)}
  .game-title{font-size:30px}
  .wrap{padding:10px}
  .btn, .choice{padding:14px 16px;font-size:14px}
  .companions { flex-wrap: wrap; }
}
</style>
</head>
<body>
<div class="wrap">

  <!-- TITLE -->
  <section class="title" id="title">
    <div>
      <div class="game-title">ë™ë¬˜ ê·€ì‹œì¥</div>
      <div class="intro" id="introText">
ìŒë ¥ ì´ˆí•˜ë£¨, ìƒë§(ä¸Šæœ›).

ë™ë¬˜ ì‚¬ë‹¹ ì•.
ë„¤ ëª…ì´ ëª¨ì˜€ë‹¤.

"ë˜ ì™”ë„¤."

ë²½ì„ ë°”ë¼ë³¸ë‹¤.
ì—¬ì „íˆ ê·¸ëƒ¥ ë²½ì´ë‹¤.

í•˜ì§€ë§Œ ê°€ë”, ì •ë§ ê°€ë”.
ë¬´ì–¸ê°€ ì—´ë¦¬ëŠ” ê²ƒ ê°™ì€ ê¸°ë¶„ì´ ë“ ë‹¤.
      </div>

      <div class="row">
        <button class="btn" id="btnEnter">ë²½ì„ ë°”ë¼ë³¸ë‹¤</button>
        <button class="btn" id="btnTutorial">ì²˜ìŒì´ì‹ ê°€ìš”?</button>
        <button class="btn" id="btnHelp">ë„ì›€ë§</button>
      </div>
    </div>
  </section>

  <!-- TUTORIAL OVERLAY -->
  <div class="tutorial-overlay" id="tutorialOverlay">
    <div class="tutorial-box">
      <div class="tutorial-title" id="tutTitle">ì œëª©</div>
      <div class="tutorial-text" id="tutText">ë‚´ìš©</div>
      <div class="choices" id="tutChoices"></div>
      <div class="tutorial-step" id="tutStep">1 / 6</div>
    </div>
  </div>

  <!-- HUD -->
  <section class="hud" id="hud">
    <div class="header">
      <div>
        <div class="h-title">ë™ë¬˜ ê·€ì‹œì¥</div>
        <div class="small" id="subinfo"></div>
      </div>
      <div class="row">
        <button class="btn" id="btnHelp2">ë„ì›€ë§</button>
      </div>
    </div>

    <!-- ì§„í–‰ë„ ë°” -->
    <div class="progress-container" id="progressContainer" style="display:none">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
      <span class="progress-text" id="progressText">ì§€í•˜ ì§„ì…ê¹Œì§€ 0%</span>
    </div>

    <!-- ë™í–‰ í‘œì‹œ -->
    <div class="companions" id="companions" style="display:none">
      <div id="comp1" class="companion-card"></div>
      <div id="comp2" class="companion-card"></div>
      <div id="comp3" class="companion-card"></div>
    </div>

    <!-- Stats / Resources -->
    <div class="statbar">
      <div class="slab">ì´ì„±<div class="v" id="sReason">3</div></div>
      <div class="slab">ê°ì •<div class="v" id="sEmp">3</div></div>
      <div class="slab">ì§ê´€<div class="v" id="sInst">3</div></div>
      <div class="slab">ì‹œê°„<div class="v" id="rTime">60</div></div>
      <div class="slab">ì •ì‹ <div class="v" id="rPsy">70</div></div>
      <div class="slab">ë‹¨ì„œ<div class="v" id="rClue">0</div></div>
    </div>
    <div class="row kv">
      <span>ì£¼í™”: <b id="rCoin">3</b></span>
      <span>ì˜ì‹¬ë„(Heat): <b id="rHeat">0</b></span>
      <span>íŒíŠ¸ ì¡°ê°: <b id="rShard">0</b></span>
      <span>ë™í–‰ ì¿¨íƒ€ì„: <b id="rCD">0</b>í„´</span>
    </div>

    <div class="panel">
      <div class="story" id="story">â€¦</div>
      <div class="choices" id="choices"></div>
    </div>

    <div class="inv" id="inv">
      <div class="small" style="margin-bottom:6px">ì†Œì§€í’ˆ</div>
      <div class="inv-grid" id="tags"></div>
    </div>
  </section>

  <!-- HELP -->
  <aside class="help" id="help">
    <div class="head">
      <div style="font-weight:800;color:#e6dbd0">ë„ì›€ë§</div>
      <button class="btn" id="btnHelpClose">ë‹«ê¸°</button>
    </div>
    <div class="body">
      <h3 style="margin:6px 0 8px;color:#e66">ê²Œì„ ëª©í‘œ</h3>
      <p class="small">
        ë§¤ì¼ ë°¤ ë™ë¬˜ì— ëª¨ì´ëŠ” ë„¤ ëª….<br>
        ì™œ ëª¨ì´ëŠ”ì§€ ì•„ë¬´ë„ ëª¨ë¦…ë‹ˆë‹¤.<br>
        ê·€ì‹œì¥ì„ íƒí—˜í•˜ë©° ì§„ì‹¤ì„ ì°¾ìœ¼ì„¸ìš”.<br>
        <b>íŒíŠ¸ ì¡°ê° 3ê°œ</b> ë˜ëŠ” <b>ë‹¨ì„œ 4ê°œ</b>ë¥¼ ëª¨ìœ¼ë©´<br>
        ì§€í•˜ë¡œ ë‚´ë ¤ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
      <hr class="sep">
      <h4>ìì› ê´€ë¦¬</h4>
      <p class="small">
        â° <b>ì‹œê°„</b>: 60â†’0 = ìƒˆë²½ ì—”ë”©<br>
        ğŸ§  <b>ì •ì‹ </b>: 70â†’0 = ê´‘ê¸° ì—”ë”©<br>
        ğŸª™ <b>ì£¼í™”</b>: ìƒì  ê±°ë˜ í™”í<br>
        ğŸ“ <b>ë‹¨ì„œ</b>: ì§„ì‹¤ì„ ì°¾ëŠ” ì—´ì‡ 
      </p>
      <h4>ëŠ¥ë ¥ì¹˜ íš¨ê³¼</h4>
      <p class="small">
        <b>ì´ì„±</b>: ìˆ˜ìˆ˜ê»˜ë¼, ë„ë°• ì„±ê³µë¥ â†‘<br>
        <b>ê°ì •</b>: ì„¤ë“, êµì„­ ì„±ê³µë¥ â†‘<br>
        <b>ì§ê´€</b>: ì „íˆ¬, ìœ„í—˜íšŒí”¼ ì„±ê³µë¥ â†‘
      </p>
      <h4>ë™í–‰ ì‹œìŠ¤í…œ</h4>
      <p class="small">
        ì„ íƒí•˜ì§€ ì•Šì€ 3ëª…ì´ ë™í–‰í•©ë‹ˆë‹¤.<br>
        ê°ì íŠ¹ìˆ˜ ëŠ¥ë ¥ì´ ìˆìŠµë‹ˆë‹¤. (ì¿¨íƒ€ì„ 2í„´)<br>
        â€¢ ê¹€ì •í˜¸: ìƒì  ê°€ê²© í• ì¸<br>
        â€¢ ì œì„ìŠ¤: ë„ë°• ì„±ê³µë¥  +10%<br>
        â€¢ ê´‘ê³ ì‚¬ì¥: êµì„­ íŒíŠ¸ (ê°ì •â‰¥4)<br>
        â€¢ ë¹„ë¦¬í˜•ì‚¬: ì „íˆ¬ +10% (ì •ì‹ -5)
      </p>
      <h4>ìƒì  ê·œì¹™</h4>
      <p class="small">
        â€¢ ê° ìƒì ì€ <b>1íšŒë§Œ</b> ê±°ë˜ ê°€ëŠ¥<br>
        â€¢ ì‹œê°„ëŒ€ë³„ë¡œ ë‹¤ë¥¸ ìƒì  ë“±ì¥<br>
        â€¢ ìˆ˜ìˆ˜ê»˜ë¼ ìƒì ì€ ì‹¤íŒ¨í•´ë„ ì•„ì´í…œ êµ¬ë§¤ ê°€ëŠ¥
      </p>
      <h4>ì˜ì‹¬ë„(Heat)</h4>
      <p class="small">
        ì‹¤íŒ¨í•  ë•Œë§ˆë‹¤ +1<br>
        3 ì´ìƒ: ë¶ˆë¦¬í•œ ì´ë²¤íŠ¸ ì¦ê°€<br>
        6 ì´ìƒ: ë§¤ìš° ìœ„í—˜
      </p>
      <p class="small notice">ğŸ’¡ ë„ì›€ë§ì—ëŠ” 'ëˆ„êµ¬'ì˜ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.<br>ëª¨ë“  ì§„ì‹¤ì€ ì§ì ‘ ë°œê²¬í•´ì•¼ í•©ë‹ˆë‹¤.</p>
    </div>
  </aside>

</div>

<script>
/* ---------- UTIL ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function rnd(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* ---------- STATE ---------- */
const state = {
  scene: 'title',
  floor: 'G',
  char: null,
  stats: { reason:3, empathy:3, instinct:3 },
  res: { time:60, psyche:70, clues:0, coins:5 },
  meta: { heat:0, shards:0, turn:0, cd:0, pity:{fight:0,gamble:0,riddle:0} },
  inv: [],
  visitedShops: new Set(),
  lockedShops: new Set(),
  flags: { 
    marketSeen:false, 
    riddleHint:false,
    exploredAreas: {},
    tutorialDone: false,
    hints: {} // í”Œë ˆì´ ì¤‘ íŒíŠ¸ í‘œì‹œ ì—¬ë¶€
  },
};

/* ---------- TUTORIAL SYSTEM ---------- */
const TUTORIAL = {
  currentStep: 0,
  steps: [
    {
      title: 'ë™ë¬˜ ê·€ì‹œì¥ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤',
      text: `ë§¤ì¼ ë°¤, ë„¤ ëª…ì´ ì´ìœ ë„ ëª¨ë¥¸ ì±„ ë™ë¬˜ì— ëª¨ì…ë‹ˆë‹¤.
ë²½ì´ ì—´ë¦¬ë©´ ê·€ì‹œì¥ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.

ê·¸ê³³ì—ì„œ ë¬´ì–¸ê°€ë¥¼ ì°¾ì•„ì•¼ í•œë‹¤ëŠ” ëŠë‚Œì´ ë“­ë‹ˆë‹¤.
í•˜ì§€ë§Œ ê·¸ê²ƒì´ ë¬´ì—‡ì¸ì§€ëŠ”... ì•„ë¬´ë„ ëª¨ë¦…ë‹ˆë‹¤.

ê²Œì„ì˜ ëª©í‘œëŠ” ì ì§„ì ìœ¼ë¡œ ë°í˜€ì§‘ë‹ˆë‹¤.`,
      choices: ['ë‹¤ìŒ']
    },
    {
      title: 'ìì› ê´€ë¦¬',
      text: `â° ì‹œê°„: 60ì—ì„œ ì‹œì‘, ë§¤ í–‰ë™ë§ˆë‹¤ ì†Œëª¨
   â†’ 0ì´ ë˜ë©´ ìƒˆë²½ì´ ì™€ì„œ ê²Œì„ ì¢…ë£Œ

ğŸ§  ì •ì‹ : 70ì—ì„œ ì‹œì‘, ì¶©ê²©ì ì¸ ì¼ì— ê°ì†Œ  
   â†’ 0ì´ ë˜ë©´ ê´‘ê¸°ì— ë¹ ì ¸ ê²Œì„ ì¢…ë£Œ

ğŸª™ ì£¼í™”: 5ê°œë¡œ ì‹œì‘, ìƒì  ê±°ë˜ì— ì‚¬ìš©
   â†’ 0ì´ ë˜ë©´ ë¹šì„ ì§€ê±°ë‚˜ ë²Œì–´ì•¼ í•¨
ğŸ“ ë‹¨ì„œ: ì§„ì‹¤ì„ ì°¾ëŠ” ì—´ì‡ 

ìì›ì„ ì‹ ì¤‘í•˜ê²Œ ê´€ë¦¬í•˜ì„¸ìš”!`,
      choices: ['ë‹¤ìŒ'],
      highlight: ['#rTime', '#rPsy', '#rCoin', '#rClue']
    },
    {
      title: 'ëŠ¥ë ¥ì¹˜ì™€ ì„±ê³µë¥ ',
      text: `ê° ìºë¦­í„°ëŠ” ê³ ìœ  ëŠ¥ë ¥ì¹˜ë¥¼ ê°€ì§‘ë‹ˆë‹¤:

ğŸ“– ì´ì„±: ìˆ˜ìˆ˜ê»˜ë¼, ë¶„ì„, ë„ë°•ì— ìœ ë¦¬
ğŸ’¬ ê°ì •: ì„¤ë“, êµì„­, ëŒ€í™”ì— ìœ ë¦¬  
âš¡ ì§ê´€: ì „íˆ¬, ìœ„í—˜íšŒí”¼ì— ìœ ë¦¬

ë²„íŠ¼ì— í‘œì‹œë˜ëŠ” ì„±ê³µë¥ %ë¥¼ í™•ì¸í•˜ì„¸ìš”.
ëŠ¥ë ¥ì¹˜ê°€ ë†’ì„ìˆ˜ë¡ ì„±ê³µ í™•ë¥ ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤.`,
      choices: ['ë‹¤ìŒ'],
      highlight: ['#sReason', '#sEmp', '#sInst']
    },
    {
      title: 'ìƒì ê³¼ ê±°ë˜',
      text: `ğŸ›ï¸ ê·€ì‹œì¥ì˜ ìƒì ë“¤:
â€¢ ê° ìƒì ì€ í•œ ë²ˆë§Œ ê±°ë˜ ê°€ëŠ¥
â€¢ ìˆ˜ìˆ˜ê»˜ë¼ë¥¼ í’€ë©´ ì¶”ê°€ ë³´ìƒ
â€¢ ì‹œê°„ëŒ€ë³„ë¡œ ë‹¤ë¥¸ ìƒì  ë“±ì¥

âš ï¸ ì£¼ì˜ì‚¬í•­:
â€¢ í•œ ë²ˆ ê±°ë˜í•œ ìƒì ì€ ì ê¹ë‹ˆë‹¤
â€¢ ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ìœ„í—˜í•œ ìƒì  ë“±ì¥
â€¢ ëŒ€ê°€ë¥¼ ì¹˜ëŸ¬ì•¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤`,
      choices: ['ë‹¤ìŒ']
    },
    {
      title: 'ê³¨ëª© íƒí—˜',
      text: `ê³¨ëª©ì—ì„œ ì¼ì–´ë‚˜ëŠ” ì¼ë“¤:

ğŸ‘¤ NPC ì¡°ìš°: ì„¤ë“í•˜ë©´ íŒíŠ¸ íšë“
âš”ï¸ ì „íˆ¬: ì„±ê³µì‹œ ì£¼í™” íšë“  
ğŸ² ë„ë°•: ì£¼í™”ë¥¼ 2ë°°ë¡œ ë§Œë“¤ ê¸°íšŒ
ğŸ” íƒí—˜: ìˆ¨ê²¨ì§„ ì¥ì†Œì™€ ë¹„ë°€ ë°œê²¬

ì‹¤íŒ¨í•˜ë©´ ì˜ì‹¬ë„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.
ì˜ì‹¬ë„ê°€ ë†’ìœ¼ë©´ ë¶ˆë¦¬í•´ì§‘ë‹ˆë‹¤!`,
      choices: ['ë‹¤ìŒ']
    },
    {