<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>동묘 귀시장 · 패치 v0.8</title>
<style>
:root{
  --bg:#0b0b0c;--panel:#121213;--ink:#e8e0d8;--muted:#a89f96;--accent:#8b0000;--line:#2a2a2a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1100px circle at 50% -180px,#1a0000 0%,#0b0b0c 45%,#000 100%);
  color:var(--ink);font-family:"Noto Serif KR",Pretendard,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
.wrap{max-width:960px;margin:0 auto;padding:16px}
h1{margin:0 0 6px}
.btn, .choice{background:linear-gradient(180deg,#191919,#101010);border:1px solid #2b2b2b;color:var(--ink);
  padding:12px 14px;border-radius:10px;cursor:pointer;display:inline-block;
  -webkit-tap-highlight-color:transparent;
  user-select:none}
.btn:active,.choice:active{border-color:#922;background:linear-gradient(180deg,#3a0000,#260000)}
.title{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
.game-title{font-size:40px;color:#e35;text-shadow:0 0 26px rgba(139,0,0,.55)}
.intro{white-space:pre-wrap;color:var(--muted);line-height:1.85;max-width:760px;margin:12px auto 18px}
.panel{background:linear-gradient(180deg,#171717,#0e0e0f);border:1px solid var(--line);border-radius:12px;padding:16px}
.story{min-height:220px;white-space:pre-wrap;line-height:1.9;overflow-y:auto;max-height:50vh}
.choices{margin-top:12px;display:grid;gap:10px}
.hud{display:none}
.hud.on{display:block}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.h-title{font-weight:800;color:#e66}
.statbar{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin:10px 0}
.slab{background:linear-gradient(180deg,#171717,#101012);border:1px solid #2a2a2a;border-radius:10px;padding:8px 10px;text-align:center;font-size:13px}
.slab .v{display:block;font-weight:800;margin-top:4px}
.bad{color:#f59}
.good{color:#9ef0b0}
.warn{color:#f6d37a}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
.inv{margin-top:10px;padding:10px;border:1px dashed #333;border-radius:10px;display:none}
.inv.on{display:block}
.tag{background:#151515;border:1px solid #333;padding:4px 8px;border-radius:999px;font-size:12px;margin:2px}
.kv{font-size:12px;color:#b9b0a6}
hr.sep{border:none;border-top:1px solid #272727;margin:10px 0}
.help{position:fixed;right:0;top:0;bottom:0;width:380px;max-width:94vw;background:#111;border-left:1px solid #2a2a2a;transform:translateX(100%);transition:.25s;z-index:50;overflow-y:auto}
.help.on{transform:translateX(0)}
.help .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #2a2a2a}
.help .body{padding:12px;height:calc(100% - 52px);overflow:auto}
.small{font-size:12px;color:#9a8f85}
.prob{font-size:12px;color:#caa}
.tip{font-size:12px;color:#9ab1ff}
.notice{font-size:12px;color:#b7f59e}
@media (max-width:640px){
  .statbar{grid-template-columns:repeat(3,1fr)}
  .game-title{font-size:30px}
  .wrap{padding:10px}
  .btn, .choice{padding:14px 16px;font-size:14px}
}
</style>
</head>
<body>
<div class="wrap">

  <!-- TITLE -->
  <section class="title" id="title">
    <div>
      <div class="game-title">동묘 귀시장</div>
      <div class="intro" id="introText">
음력 초하루, 상망(上望).

골목길은 낮 동안의 흔적들로 어지럽다. 술에 취한 웃음소리, 택시 불빛, 골동품점 창가의 희미한 네온사인.
상인들은 가게 문을 닫고, 버스는 마지막 승객을 내려주고, 도로 위엔 간간이 자동차 소리만 남았다.
평범한 동네, 평범한 밤.

비리형사가 동묘 사당 앞에서 담배를 피우고 있다.
연기가 하늘로 올라갔다.

김정호가 있었다. 제임스도 있었다. 광고대행사 사장도.

아무도 먼저 오자고 하지 않았는데.

"또 왔네."

제임스가 웃었다. 씁쓸한 웃음이었다.

"뭘 기대하는 거지?"

김정호가 물었다.

"모르겠어."

제임스가 답했다.

벽을 바라봤다. 여전히 그냥 벽이었다.

하지만 가끔, 정말 가끔.
바람이 불면.
무언가 열리는 것 같은 기분이 들었다.

착각이었다.
분명 착각이었다.

그런데도 그들은 매일 밤 왔다.
기다렸다.
무엇을 기다리는지도 모른 채.

어디선가 방울 소리가 들렸다.
고양이 목에 달린 방울이었다. 길고양이가 지나갔다.
그뿐이었다.
      </div>

      <div class="row">
        <button class="btn" id="btnEnter">벽을 바라본다</button>
        <button class="btn" id="btnHelp">도움말</button>
      </div>
    </div>
  </section>

  <!-- HUD -->
  <section class="hud" id="hud">
    <div class="header">
      <div>
        <div class="h-title">동묘 귀시장</div>
        <div class="small" id="subinfo"></div>
      </div>
      <div class="row">
        <button class="btn" id="btnHelp2">도움말</button>
      </div>
    </div>

    <!-- Stats / Resources -->
    <div class="statbar">
      <div class="slab">이성<div class="v" id="sReason">3</div></div>
      <div class="slab">감정<div class="v" id="sEmp">3</div></div>
      <div class="slab">직관<div class="v" id="sInst">3</div></div>
      <div class="slab">시간<div class="v" id="rTime">60</div></div>
      <div class="slab">정신<div class="v" id="rPsy">70</div></div>
      <div class="slab">단서<div class="v" id="rClue">0</div></div>
    </div>
    <div class="row kv">
      <span>주화: <b id="rCoin">3</b></span>
      <span>의심도(Heat): <b id="rHeat">0</b></span>
      <span>힌트 조각: <b id="rShard">0</b></span>
      <span>동행 도움 쿨타임: <b id="rCD">0</b>턴</span>
    </div>

    <div class="panel">
      <div class="story" id="story">…</div>
      <div class="choices" id="choices"></div>
    </div>

    <div class="inv" id="inv">
      <div class="small" style="margin-bottom:6px">소지품</div>
      <div id="tags"></div>
    </div>
  </section>

  <!-- HELP -->
  <aside class="help" id="help">
    <div class="head">
      <div style="font-weight:800;color:#e6dbd0">도움말 / 규칙 / 튜토리얼</div>
      <button class="btn" id="btnHelpClose">닫기</button>
    </div>
    <div class="body">
      <h3 style="margin:6px 0 8px;color:#e66">핵심 규칙</h3>
      <p class="small">
        • 목표: 이름 없는 진실에 닿아 지하로 내려가고, 마지막에 선택하라.<br>
        • 상점은 한 번 거래하면 잠깁니다. (첫 거래 후 재입장 불가)<br>
        • 골목에서 NPC·전투·도박·교환으로 <b>힌트 조각</b>과 단서를 모으세요.<br>
        • <b>힌트 조각 ≥ 3</b> 또는 <b>단서 ≥ 4</b>면 바닥 문양이 반응 → 지하로 하강.<br>
        • 시간(60)은 매 행동에 소모, 0이면 새벽 엔딩. 정신 0이면 광기 엔딩.<br>
        • 버튼에 <span class="tip">성공률%</span>이 보입니다. 동행 호출/아이템으로 보정 가능.
      </p>
      <hr class="sep">
      <h4>능력치</h4>
      <p class="small">
        • <b>이성</b>: 수수께끼/분석/해독 성공률↑<br>
        • <b>감정</b>: 설득/교섭/교환/특정 상점 호감 보정↑<br>
        • <b>직관</b>: 전투/도박/위험회피/행운 보정↑
      </p>
      <h4>동행(쿨 2턴)</h4>
      <p class="small">
        • 형사: 전투 +10% (정신 -5), 제임스: 도박 +10% (주화 -1),<br>
        • 광고사장: 교섭/수수께끼 힌트 (감정≥4 필요), 김정호: 가격 -1 (상점 1회)
      </p>
      <h4>의심도(Heat)</h4>
      <p class="small">
        • 실패/무리한 행동 시 +1. 3/6에 매복·가격인상 등 리스크 증가.
      </p>
      <h4>시간대 상점</h4>
      <p class="small">
        • 축시 초반엔 2~3곳, 중반 3~4곳, 끝자락 1곳 등 가변. 함정 상점 등장 가능.
      </p>
      <p class="small notice">도움말엔 '누구'의 이름이 없습니다. 모든 건 직접 밝혀야 합니다.</p>
    </div>
  </aside>

</div>

<script>
/* ---------- UTIL ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function rnd(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* ---------- STATE ---------- */
const state = {
  scene: 'title',
  floor: 'G',
  char: null,
  stats: { reason:3, empathy:3, instinct:3 },
  res: { time:60, psyche:70, clues:0, coins:3 },
  meta: { heat:0, shards:0, turn:0, cd:0, pity:{fight:0,gamble:0,riddle:0} },
  inv: [],
  visitedShops: new Set(),
  lockedShops: new Set(),
  flags: { marketSeen:false, riddleHint:false },
};

/* ---------- DATA: SHOPS ---------- */
const SHOPS = [
  {
    id:'jewel',
    name:'영혼의 보석상',
    type:'riddle',
    openAt:'any',
    intro: `유리 진열장에 감정이 굳어 앉아 있었다. 파란빛은 오래된 울음, 붉은빛은 입술의 흉터, 초록빛은 말라붙은 그리움.
상인은 웃는지 아닌지 알 수 없는 목소리로 말했다. 
"원하는 건 알죠. 가진 걸 모를 뿐."`,
    riddle: {
      q:`"한 왕이 있었습니다. 
모든 슬픔을 팔아 왕국을 지켰고, 모든 분노를 팔아 평화를 샀으며, 모든 그리움을 팔아 미래를 얻었습니다.
그는 왜 무너졌을까요?"`,
      a:[
        { key:'인간성의 상실', text:'감정 없는 왕은 더 이상 인간이 아니었다', effect:()=>{ gain('clues',2); pushInv('지혜의 조각'); msg('상인은 고개를 끄덕였다. "껍데기는 오래 못 갑니다." (단서+2)'); } , pref:true },
        { key:'백성의 이탈', text:'백성들이 감정 없는 왕을 따르지 않았다', effect:()=>{ gain('clues',1); msg('"반쯤은요."(단서+1)'); } },
        { key:'기억의 잔존', text:'감정을 팔아도 기억은 남았다', effect:()=>{ state.stats.reason++; msg('"흥미로운 관찰." (이성+1)'); } }
      ]
    },
    items:[
      {name:'슬픔의 사파이어', cost:{coins:2, psyche:10,time:6}, lore:'울지 못하는 평온. 단, 오래 보면 차갑다.', effect:()=>{ pushInv('슬픔의 사파이어'); state.flags.riddleHint=true; }},
      {name:'분노의 루비', cost:{coins:2, psyche:5,time:6}, lore:'불로 쥔 정의. 단, 손바닥이 탄다.', effect:()=>{ pushInv('분노의 루비'); }},
      {name:'그리움의 에메랄드', cost:{coins:1, psyche:8,time:6}, lore:'뒤돌아보지 않게 해준다. 대신 내일이 흐릿해진다.', effect:()=>{ pushInv('그리움의 에메랄드'); }},
      {name:'후회의 다이아몬드', cost:{coins:3, psyche:12,time:8}, lore:'결정을 되짚게 한다. 단, 되돌릴 수 없는 것만 선명해진다.', effect:()=>{ pushInv('후회의 다이아몬드'); }}
    ],
  },
  { id:'memory', name:'기억엄색소', type:'trade', openAt:'any',
    intro:`허연 눈동자의 노파. 비단주머니 셋을 꺼내며 중얼거렸다. "잊은 줄 알았던 것, 잊고 싶었던 것, 잊어야 했던 것."`,
    items:[
      {name:'첫사랑의 마지막 인사', cost:{coins:1,time:5,psyche:6}, lore:'따뜻하지만 오래 보관하면 흐려진다.', effect:()=>{ pushInv('첫사랑의 마지막 인사'); addShard(1); gain('clues',1); }},
      {name:'깨끗했던 마음', cost:{coins:2,time:6,psyche:8}, lore:'잠깐의 용기. 다음 선택이 무거워진다.', effect:()=>{ pushInv('깨끗했던 마음'); addShard(1); gain('clues',1); }},
      {name:'희미한 이름 쪽지', cost:{coins:1,time:5}, lore:'물에 번진 필기체. 자음 하나가 남는다.', effect:()=>{ pushInv('쪽지(자음)'); addShard(1); }}
    ]
  },
  { id:'reassemble', name:'과거 재조립점', type:'trade', openAt:'any',
    intro:`나무상 위에 분해된 회중시계. 주인은 태엽을 들어 보이며 말했다. "빠진 건 늘 제일 작은 거지."`,
    items:[
      {name:'태엽 조각', cost:{coins:1,time:5}, lore:'아무것도 하지 않는 조각. 그러나 없는 것보단 낫다.', effect:()=>{ pushInv('태엽 조각'); addShard(1);} },
      {name:'낡은 나사못', cost:{coins:1,time:4}, lore:'구멍이 헐거운 기억에 박는다.', effect:()=>{ pushInv('낡은 나사못'); }},
      {name:'미세한 스프링', cost:{coins:1,time:4}, lore:'팽팽할수록 잘 끊어진다.', effect:()=>{ pushInv('미세한 스프링'); }}
    ]
  },
  { id:'desire', name:'욕망 매입소', type:'trade', openAt:'mid',
    intro:`붉은 향이 코를 찔렀다. "무엇을 잃고 싶으신가요?"`,
    items:[
      {name:'가벼운 양심', cost:{psyche:10,time:6}, lore:'죄책감이 덜 무겁다. 대신 의심이 빨리 붙는다.', effect:()=>{ pushInv('가벼운 양심'); state.meta.heat++; }},
      {name:'돈 냄새', cost:{coins:1,time:4}, lore:'전부가 그 냄새로 보인다.', effect:()=>{ pushInv('돈 냄새'); }}
    ]
  },
  { id:'post', name:'망자의 우체국', type:'trade', openAt:'late',
    intro:`공중에 편지들이 떠다녔다. 우체국장은 이미 오래전에 죽은 듯했다. "누구에게 보낼까요?"`,
    items:[
      {name:'사죄의 편지', cost:{time:6,psyche:8}, lore:'답은 오지 않는다. 마음은 가벼워진다.', effect:()=>{ pushInv('사죄의 편지'); gain('clues',1);} },
      {name:'질문의 편지', cost:{time:6,coins:1}, lore:'가끔 답장이 온다. 대개는 늦다.', effect:()=>{ pushInv('질문의 편지'); if(Math.random()<0.4){ addShard(1); msg('느린 답장: 힌트 조각 +1'); }} }
    ]
  }
];

/* ---------- MARKET ROLL ---------- */
function openMarket(){
  state.scene='market';
  
  // 게임 종료 체크
  if (state.res.time <= 0) {
    return endingDawn();
  }
  if (state.res.psyche <= 0) {
    return endingMadness();
  }
  
  // 시간대에 따른 상점 수
  const t = state.res.time;
  let count = 3;
  if (t>45) count = 2 + rnd(0,1);
  else if (t>20) count = 3 + rnd(0,1);
  else count = 1 + rnd(0,1);

  const pool = SHOPS.filter(s=>{
    if (state.lockedShops.has(s.id)) return false;
    if (state.visitedShops.has(s.id)) return true;
    if (s.openAt==='mid' && t>40) return false;
    if (s.openAt==='late' && t>25) return false;
    return true;
  });

  const options = shuffle(pool).slice(0, Math.max(1, Math.min(count, pool.length)));

  setText(`상점들을 바라본다.

붉은 등불 아래, 피로 쓴 간판들이 미세하게 떨린다.
손으로 그린 글씨, 번진 잉크, 금빛 나비 날개 장식—.

어디로 들어갈까?`);
  const ch=[];
  options.forEach(s=>{
    ch.push({text:`🛍️ ${s.name}`, fn:()=>enterShop(s.id)});
  });
  ch.push({text:`🔎 골목으로 나가 본다 (시간 -4)`, fn:()=>{ spend({time:4}); alley(); }});
  
  // 하강 게이트
  if (state.meta.shards>=3 || state.res.clues>=4){
    ch.push({text:`⬇️ 바닥 문양이 미세하게 빛난다 (지하로 내려간다 · 시간 -8)`, fn:()=>{ spend({time:8}); descendB1(); }});
  } else {
    const needShards = 3 - state.meta.shards;
    const needClues = 4 - state.res.clues;
    ch.push({text:`❌ 바닥 문양이 반응하지 않는다 (힌트 조각 ${needShards}개 또는 단서 ${needClues}개 더 필요)`, fn:()=>{ 
      msg('문양이 희미하게 깜빡이다 꺼졌다. 아직 부족하다.'); 
    }});
  }
  
  // 긴급 탈출
  if (t <= 15 || state.res.psyche <= 20) {
    ch.push({text:`🚪 포기하고 현실로 돌아간다 (게임 종료)`, fn:()=>{ 
      endingGiveUp(); 
    }});
  }
  
  setChoices(ch);
}

/* ---------- SHOP ---------- */
function enterShop(id){
  const s = SHOPS.find(x=>x.id===id);
  if (!s) return;
  if (state.lockedShops.has(id)){
    setText(`${s.name}\n\n문이 굳게 잠겼다. "한 영혼, 한 번."`);
    setChoices([{text:'돌아간다', fn:openMarket}]);
    return;
  }
  state.visitedShops.add(id);

  if (s.type==='riddle'){
    setText(`${s.name}\n\n${s.intro}\n\n${s.riddle.q}`);
    const base = baseChance('riddle');
    const hint = state.flags.riddleHint || state.stats.empathy>=4;
    const ch = s.riddle.a.map(opt=>{
      const p = clamp(base + (opt.pref? +10:0) + (hint? +10:0), 15, 95);
      return {text:`${opt.text}  <span class="prob">성공 ${p}%</span>`, fn:()=>roll(p,
        ()=>{ opt.effect(); afterRiddle(s); },
        ()=>{ failMark('riddle'); heatUp(1); msg('상인은 고개를 젓는다. "그 대답으론 못 삽니다."'); afterRiddle(s); }
      )};
    });
    setChoices([...ch, {text:'나간다', fn:openMarket}]);
  } else {
    setText(`${s.name}\n\n${s.intro}\n\n진열대를 훑는다.`);
    const ch=[];
    s.items.forEach(it=>{
      const costTxt = costToText(it.cost);
      ch.push({text:`${it.name} — ${costTxt}\n<span class="small">${it.lore}</span>`, fn:()=>buyItem(s,it)});
    });
    ch.push({text:'나간다', fn:openMarket});
    setChoices(ch);
  }
}

function afterRiddle(s){
  const ch = s.items.map(it=>({text:`구매: ${it.name} — ${costToText(it.cost)}\n<span class="small">${it.lore}</span>`, fn:()=>buyItem(s,it)}));
  ch.push({text:'나간다', fn:openMarket});
  setChoices(ch);
}

function buyItem(shop, it){
  if (!canPay(it.cost)){ msg('대가가 부족하다.'); return; }
  pay(it.cost);
  it.effect && it.effect();
  state.lockedShops.add(shop.id);
  msg(`거래가 끝나자 진열장의 불빛이 하나씩 꺼졌다. (${shop.name} 잠김)`);
  updateHUD();
  setChoices([{text:'골목으로 나간다', fn:openMarket}]);
}

/* ---------- ALLEY ---------- */
function alley(){
  state.scene='alley';
  const roll = Math.random();
  if (roll<0.34) return npcEncounter();
  if (roll<0.67) return lightFight();
  return gambling();
}

function npcEncounter(){
  setText(`골목. 등불이 없는 어둠 쪽에서 손이 나와 소매를 잡는다.

"이거 찾는 거 아니었어?"`);
  const base = baseChance('talk');
  const p = clamp(base + state.stats.empathy*6 - state.meta.heat*5, 10, 95);
  const useAd = (state.stats.empathy>=4);
  const ch = [
    {text:`설득해 본다 <span class="prob">성공 ${p}%</span>`, fn:()=>roll(p,
      ()=>{ addShard(1); gain('clues',1); msg('노파가 비단주머니를 쥐여준다. (힌트 조각+1, 단서+1)'); openMarket(); },
      ()=>{ heatUp(1); losePsy(6); msg('"그 눈빛이 싫어." 손이 사라졌다. (의심도+1, 정신-6)'); openMarket(); }
    )},
  ];
  
  if (state.char !== '광고사장' && useAd) {
    ch.push({text:`광고사장에게 말을 걸어달라고 한다 (감정≥4, 쿨 2턴)`, fn:()=>callCompanion('ad', ()=>{ 
      addShard(1); 
      msg('"말은 이렇게 다는 거야." 광고사장이 능숙하게 대화를 이끌었다. (힌트 조각+1)'); 
      openMarket(); 
    })});
  }
  
  if (state.char !== '제임스') {
    ch.push({text:`제임스에게 협상을 맡긴다 (주화 -1, 쿨 2턴)`, fn:()=>callCompanion('james', ()=>{ 
      gain('clues', 1);
      msg('"이런 건 내 전문이지." 제임스가 능숙하게 교섭했다. (단서+1)'); 
      openMarket(); 
    })});
  }
  
  ch.push({text:'그냥 지나친다 (시간 -3)', fn:()=>{ spend({time:3}); openMarket(); }});
  setChoices(ch);
}

function lightFight(){
  setText(`구석에서 발소리. 그림자가 달려든다.`);
  const base = baseChance('fight');
  let p = base + state.stats.instinct*6 - state.meta.heat*5;
  if (has('분노의 루비') && has('태엽 조각')) p += 15;
  p = clamp(p, 10, 95);
  const ch = [
    {text:`대응한다 <span class="prob">성공 ${p}%</span>`, fn:()=>roll(p,
      ()=>{ gain('coins',1); msg('주머니에서 낡은 주화가 굴러나왔다. (주화+1)'); openMarket(); },
      ()=>{ heatUp(1); losePsy(8); msg('싸늘한 무언가가 팔을 스쳤다. (정신-8, 의심도+1)'); openMarket(); }
    )}
  ];
  
  if (state.char !== '비리형사') {
    ch.push({text:`형사에게 도움을 요청한다 (정신 -5, 쿨 2턴, 성공+10%)`, fn:()=>callCompanion('cop', ()=>{
      let q = clamp(p+10,10,95);
      roll(q, ()=>{ gain('coins',1); msg('형사가 조용히 제압했다. (주화+1)'); openMarket(); },
                 ()=>{ heatUp(1); losePsy(6); msg('"다음엔 피하라니까." (정신-6, 의심도+1)'); openMarket(); });
    })});
  }
  ch.push({text:'도망친다 (시간 -4)', fn:()=>{ spend({time:4}); heatUp(1); openMarket(); }});
  setChoices(ch);
}

function gambling(){
  setText(`허름한 노점—컵 세 개가 쉭쉭 움직인다. "맞히면 두 배."`);
  const base = baseChance('gamble');
  let p = clamp(base + state.stats.reason*5 - lossStreak('gamble')*5, 10, 90);
  const ch = [
    {text:`주화 1개 베팅 <span class="prob">성공 ${p}%</span>`, fn:()=>bet(1,p)},
  ];
  
  if (state.char !== '제임스') {
    ch.push({text:`제임스의 도움을 받는다 (주화 -1, 쿨 2턴, 성공+10%)`, fn:()=>callCompanion('james', ()=>{
      bet(1, clamp(p+10,10,95), true);
    })});
  }
  
  if (state.char !== '김정호') {
    ch.push({text:`김정호에게 흥정을 부탁한다 (쿨 2턴, 베팅액 할인)`, fn:()=>callCompanion('kim', ()=>{
      if (state.res.coins >= 1) {
        roll(p, 
          ()=>{ state.res.coins += 2; pityReset('gamble'); msg(`김정호가 흥정했다. "이 정도면 괜찮지?" (주화+2)`); openMarket(); },
          ()=>{ pityUp('gamble'); heatUp(1); losePsy(4); msg('김정호도 못 막았다. (정신-4, 의심도+1)'); openMarket(); }
        );
      } else {
        msg('주화가 부족하다.');
      }
    })});
  }
  
  ch.push({text:`그만둔다 (시간 -2, 의심도 -1)`, fn:()=>{ spend({time:2}); heatDown(1); openMarket(); }});
  setChoices(ch);
}

function bet(amount, p, paid){
  if (state.res.coins<amount){ msg('주화가 부족하다.'); return; }
  if (!paid) state.res.coins -= amount;
  roll(p,
    ()=>{ state.res.coins += amount*2; pityReset('gamble'); msg(`낙찰처럼 가볍게 들어올랐다. (주화+${amount})`); openMarket(); },
    ()=>{ pityUp('gamble'); heatUp(1); losePsy(4); msg('컵 밑은 텅 비었다. (정신-4, 의심도+1)'); openMarket(); }
  ); updateHUD();
}

/* ---------- DESCENT ---------- */
function descendB1(){
  state.floor='B1';
  setText(`바닥 문양의 파란빛이 커졌다. 꿀처럼 무거운 공기가 가라앉는다.
계단은 보이지 않았지만, 아래로 내려가고 있었다.`);
  setChoices([
    {text:'어둠 속으로 한 발 (시간 -3)', fn:()=>{ spend({time:3}); b1Hub(); }}
  ]);
}

function b1Hub(){
  setText(`지하 1층. 소음이 멀다. 상점 간판은 더 왜곡되었다.

여기서는 더 이상 오래 머무를 수 없다—.`);
  const ch=[];
  ch.push({text:'상점들을 살핀다', fn:openMarket});
  ch.push({text:'골목으로 나가 본다 (시간 -5)', fn:()=>{ spend({time:5}); alley(); }});
  setChoices(ch);
}

/* ---------- CHANCE CORE ---------- */
function baseChance(kind){
  let b=40;
  if (kind==='fight') b=35;
  if (kind==='gamble') b=45;
  if (kind==='talk' || kind==='riddle') b=40;
  b += Math.min(20, lossStreak(kind)*10);
  return b;
}

function roll(p, onSuccess, onFail){
  state.meta.turn++;
  const r = Math.random()*100;
  if (r < p){ onSuccess&&onSuccess(); }
  else { onFail&&onFail(); }
  updateHUD();
  const sh = state.meta.shards;
  if ([2,5,8].includes(sh)) { msg('어딘가에서 방울 소리. 화면 가장자리가 붉어진다.'); }
  cdTick();
}

function lossStreak(kind){ return clamp(state.meta.pity[kind]||0,0,2); }
function pityUp(kind){ state.meta.pity[kind] = clamp((state.meta.pity[kind]||0)+1,0,2); }
function pityReset(kind){ state.meta.pity[kind]=0; }
function failMark(kind){ pityUp(kind); }

/* ---------- COMPANIONS ---------- */
function getCompanions(){
  const all = ['김정호', '제임스', '광고사장', '비리형사'];
  return all.filter(n => n !== state.char);
}

function callCompanion(who, cb){
  if (state.meta.cd>0){ 
    msg('동행들이 숨 고르는 중이다. (쿨타임 '+state.meta.cd+'턴)'); 
    return; 
  }
  
  if (who==='ad' && state.stats.empathy<4){ 
    msg('감정이 부족해 광고사장이 말문을 트지 못한다. (감정≥4 필요)'); 
    return; 
  }
  
  if (who==='james'){
    if (state.res.coins<1){ 
      msg('제임스에게 넣어줄 주화가 없다.'); 
      return; 
    }
    state.res.coins -= 1;
  }
  
  if (who==='cop'){ 
    losePsy(5); 
  }
  
  state.meta.cd=2;
  cb&&cb();
  updateHUD();
}

function getCompanionName(id){
  const names = {
    'cop': '비리형사',
    'james': '제임스', 
    'ad': '광고사장',
    'kim': '김정호'
  };
  return names[id] || '알 수 없음';
}

function cdTick(){ if (state.meta.cd>0) state.meta.cd--; }

/* ---------- ECON ---------- */
function canPay(cost={}){
  const c = cost;
  if ((c.coins||0) > state.res.coins) return false;
  if ((c.time||0) > state.res.time) return false;
  if ((c.psyche||0) > state.res.psyche) return false;
  return true;
}

function pay(cost={}){
  for (const k in cost){
    if (k==='coins') state.res.coins -= cost[k];
    if (k==='time') state.res.time -= cost[k];
    if (k==='psyche') state.res.psyche -= cost[k];
  }
  updateHUD();
}

function spend(delta){ pay(delta); }
function gain(k, v){ state.res[k]+=v; updateHUD(); }
function losePsy(v){ state.res.psyche = Math.max(0, state.res.psyche - v); updateHUD(); }
function heatUp(v){ state.meta.heat = clamp(state.meta.heat+v,0,9); updateHUD(); }
function heatDown(v){ state.meta.heat = clamp(state.meta.heat-v,0,9); updateHUD(); }
function pushInv(name){ state.inv.push(name); renderInv(); updateHUD(); }
function has(name){ return state.inv.includes(name); }
function addShard(v){ state.meta.shards += v; renderInv(); updateHUD(); }

function costToText(c){
  const arr=[];
  if (c.coins) arr.push(`주화-${c.coins}`);
  if (c.psyche) arr.push(`정신-${c.psyche}`);
  if (c.time) arr.push(`시간-${c.time}`);
  return arr.join(', ');
}

/* ---------- UI CORE ---------- */
function setText(t){ $('#story').textContent=t; }

function setChoices(list){
  const box = $('#choices'); 
  box.innerHTML='';
  
  list.forEach(it=>{
    const b = document.createElement('button'); 
    b.className = 'choice';
    b.innerHTML = it.text;
    
    // 단순하게 onclick 사용 (모바일/데스크톱 모두 지원)
    b.onclick = function() {
      it.fn();
    };
    
    box.appendChild(b);
  });
}

function renderInv(){
  const invBox = $('#inv'); 
  const tags = $('#tags'); 
  tags.innerHTML='';
  const all = [...state.inv];
  if (state.meta.shards>0) all.push(`힌트 조각 ×${state.meta.shards}`);
  if (all.length){ invBox.classList.add('on'); }
  else { invBox.classList.remove('on'); }
  all.forEach(n=>{
    const s=document.createElement('span'); 
    s.className='tag'; 
    s.textContent=n; 
    tags.appendChild(s);
  });
}

function updateHUD(){
  $('#sReason').textContent = state.stats.reason;
  $('#sEmp').textContent = state.stats.empathy;
  $('#sInst').textContent = state.stats.instinct;
  $('#rTime').textContent = state.res.time;
  $('#rPsy').textContent = state.res.psyche;
  $('#rClue').textContent = state.res.clues;
  $('#rCoin').textContent = state.res.coins;
  $('#rHeat').textContent = state.meta.heat;
  $('#rShard').textContent = state.meta.shards;
  $('#rCD').textContent = state.meta.cd;
  $('#subinfo').textContent = `${state.char? state.char+' · ':''}${state.floor}층 · 턴 ${state.meta.turn}`;
}

/* ---------- FLOW ---------- */
function startPrologue(){
  $('#title').style.display='none';
  $('#hud').classList.add('on');
  updateHUD();
  
  setText(`그 순간,
모든 현실은 사라졌다.

전무는 동묘 사당 안으로 발을 내디뎠다.
공기가 무너졌다. 꿀처럼 무겁고 혀끝에선 쇠맛.

머리 위로 검은/붉은/금빛 실타래가 하늘 대신 얽혀 있고,
그 사이로 주홍빛 등불들이 둥둥 떠다니며
지나가는 사람들의 그림자를 따라갔다.

"욕망 매입소."
"미래 도색소."
"과거 재조립점."
"죽음 임대소."

두꺼운 벽돌 바닥, 축축한 감촉.
원형 문양이 희미한 파란빛을 흘리고 있었다.

…나는 누구지?`);
  
  setChoices([
    {text:'기억을 더듬는다 — 김정호(사업가)', fn:()=>pickChar('김정호', {reason:+1})},
    {text:'기억을 더듬는다 — 제임스(기획실장)', fn:()=>pickChar('제임스', {reason:+1})},
    {text:'기억을 더듬는다 — 광고대행사 사장', fn:()=>pickChar('광고사장', {empathy:+1})},
    {text:'기억을 더듬는다 — 비리형사', fn:()=>pickChar('비리형사', {instinct:+1})},
  ]);
}

function pickChar(name, bonus){
  state.char=name;
  if (bonus.reason) state.stats.reason++;
  if (bonus.empathy) state.stats.empathy++;
  if (bonus.instinct) state.stats.instinct++;
  updateHUD();
  
  const companions = getCompanions();
  setText(`나는 ${name}이다.

뒤에서 세 명의 그림자가 따라붙는다.
${companions[0]}, ${companions[1]}, ${companions[2]}.

우리는 함께 들어왔다.
필요할 때 그들의 도움을 요청할 수 있다.

등불이 흔들리며 길이 벌어졌다.`);
  
  setChoices([{text:'상점들을 바라본다', fn:openMarket}]);
}

/* ---------- ENDINGS ---------- */
function endingDawn(){
  setText(`새벽이 왔다.

동이 트자 귀시장은 사라졌다.
상점들은 연기처럼 흩어지고, 등불은 꺼졌다.
나는 동묘 사당 앞에 서 있었다.

평범한 아침. 평범한 거리.
아무 일도 없었던 것처럼.

하지만 주머니에는 ${state.inv.length>0 ? state.inv[0] : '무언가'}가 남아있었다.

[새벽 엔딩 - 시간 초과]`);
  setChoices([{text:'다시 시작', fn:()=>location.reload()}]);
}

function endingMadness(){
  setText(`정신이 무너졌다.

현실과 환상의 경계가 사라졌다.
나는 더 이상 누구인지 모른다.
${state.char}였는지, 아니면 다른 누군가였는지.

붉은 등불만이 영원히 깜빡인다.
영원히.
영원히.

[광기 엔딩 - 정신력 소진]`);
  setChoices([{text:'다시 시작', fn:()=>location.reload()}]);
}

function endingGiveUp(){
  setText(`충분하다.

나는 뒤돌아섰다.
귀시장의 유혹을 뿌리치고 현실로 돌아왔다.

때로는 모르는 채로 남겨두는 것이
더 나은 선택일 수도 있다.

수집한 단서: ${state.res.clues}
힌트 조각: ${state.meta.shards}

[포기 엔딩]`);
  setChoices([{text:'다시 시작', fn:()=>location.reload()}]);
}

/* ---------- HELP ---------- */
function showHelp(){ $('#help').classList.add('on'); }
function hideHelp(){ $('#help').classList.remove('on'); }

/* ---------- MISC ---------- */
function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((p,q)=>p[0]-q[0]).map(x=>x[1]); }
function msg(t){ 
  const s=$('#story'); 
  s.textContent += `\n\n${t}`;
}

/* ---------- INIT ---------- */
// 단순하게 onclick 사용
$('#btnEnter').onclick = startPrologue;
$('#btnHelp').onclick = showHelp;
$('#btnHelp2').onclick = showHelp;
$('#btnHelpClose').onclick = hideHelp;

// 최초 표시
updateHUD();

</script>
</body>
</html>