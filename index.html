<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>ë™ë¬˜ ê·€ì‹œì¥ Â· íŒ¨ì¹˜ v0.8</title>
<style>
:root{
  --bg:#0b0b0c;--panel:#121213;--ink:#e8e0d8;--muted:#a89f96;--accent:#8b0000;--line:#2a2a2a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1100px circle at 50% -180px,#1a0000 0%,#0b0b0c 45%,#000 100%);
  color:var(--ink);font-family:"Noto Serif KR",Pretendard,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
.wrap{max-width:960px;margin:0 auto;padding:16px}
h1{margin:0 0 6px}
.btn, .choice{background:linear-gradient(180deg,#191919,#101010);border:1px solid #2b2b2b;color:var(--ink);
  padding:12px 14px;border-radius:10px;cursor:pointer;display:inline-block;
  -webkit-tap-highlight-color:transparent;
  user-select:none}
.btn:active,.choice:active{border-color:#922;background:linear-gradient(180deg,#3a0000,#260000)}
.title{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
.game-title{font-size:40px;color:#e35;text-shadow:0 0 26px rgba(139,0,0,.55)}
.intro{white-space:pre-wrap;color:var(--muted);line-height:1.85;max-width:760px;margin:12px auto 18px}
.panel{background:linear-gradient(180deg,#171717,#0e0e0f);border:1px solid var(--line);border-radius:12px;padding:16px}
.story{min-height:220px;white-space:pre-wrap;line-height:1.9;overflow-y:auto;max-height:50vh}
.choices{margin-top:12px;display:grid;gap:10px}
.hud{display:none}
.hud.on{display:block}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.h-title{font-weight:800;color:#e66}
.statbar{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin:10px 0}
.slab{background:linear-gradient(180deg,#171717,#101012);border:1px solid #2a2a2a;border-radius:10px;padding:8px 10px;text-align:center;font-size:13px}
.slab .v{display:block;font-weight:800;margin-top:4px}
.bad{color:#f59}
.good{color:#9ef0b0}
.warn{color:#f6d37a}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
.inv{margin-top:10px;padding:10px;border:1px dashed #333;border-radius:10px;display:none}
.inv.on{display:block}
.tag{background:#151515;border:1px solid #333;padding:4px 8px;border-radius:999px;font-size:12px;margin:2px}
.kv{font-size:12px;color:#b9b0a6}
hr.sep{border:none;border-top:1px solid #272727;margin:10px 0}
.help{position:fixed;right:0;top:0;bottom:0;width:380px;max-width:94vw;background:#111;border-left:1px solid #2a2a2a;transform:translateX(100%);transition:.25s;z-index:50;overflow-y:auto}
.help.on{transform:translateX(0)}
.help .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #2a2a2a}
.help .body{padding:12px;height:calc(100% - 52px);overflow:auto}
.small{font-size:12px;color:#9a8f85}
.prob{font-size:12px;color:#caa}
.tip{font-size:12px;color:#9ab1ff}
.notice{font-size:12px;color:#b7f59e}
@media (max-width:640px){
  .statbar{grid-template-columns:repeat(3,1fr)}
  .game-title{font-size:30px}
  .wrap{padding:10px}
  .btn, .choice{padding:14px 16px;font-size:14px}
}
</style>
</head>
<body>
<div class="wrap">

  <!-- TITLE -->
  <section class="title" id="title">
    <div>
      <div class="game-title">ë™ë¬˜ ê·€ì‹œì¥</div>
      <div class="intro" id="introText">
ìŒë ¥ ì´ˆí•˜ë£¨, ìƒë§(ä¸Šæœ›).

ê³¨ëª©ê¸¸ì€ ë‚® ë™ì•ˆì˜ í”ì ë“¤ë¡œ ì–´ì§€ëŸ½ë‹¤. ìˆ ì— ì·¨í•œ ì›ƒìŒì†Œë¦¬, íƒì‹œ ë¶ˆë¹›, ê³¨ë™í’ˆì  ì°½ê°€ì˜ í¬ë¯¸í•œ ë„¤ì˜¨ì‚¬ì¸.
ìƒì¸ë“¤ì€ ê°€ê²Œ ë¬¸ì„ ë‹«ê³ , ë²„ìŠ¤ëŠ” ë§ˆì§€ë§‰ ìŠ¹ê°ì„ ë‚´ë ¤ì£¼ê³ , ë„ë¡œ ìœ„ì—” ê°„ê°„ì´ ìë™ì°¨ ì†Œë¦¬ë§Œ ë‚¨ì•˜ë‹¤.
í‰ë²”í•œ ë™ë„¤, í‰ë²”í•œ ë°¤.

ë¹„ë¦¬í˜•ì‚¬ê°€ ë™ë¬˜ ì‚¬ë‹¹ ì•ì—ì„œ ë‹´ë°°ë¥¼ í”¼ìš°ê³  ìˆë‹¤.
ì—°ê¸°ê°€ í•˜ëŠ˜ë¡œ ì˜¬ë¼ê°”ë‹¤.

ê¹€ì •í˜¸ê°€ ìˆì—ˆë‹¤. ì œì„ìŠ¤ë„ ìˆì—ˆë‹¤. ê´‘ê³ ëŒ€í–‰ì‚¬ ì‚¬ì¥ë„.

ì•„ë¬´ë„ ë¨¼ì € ì˜¤ìê³  í•˜ì§€ ì•Šì•˜ëŠ”ë°.

"ë˜ ì™”ë„¤."

ì œì„ìŠ¤ê°€ ì›ƒì—ˆë‹¤. ì”ì“¸í•œ ì›ƒìŒì´ì—ˆë‹¤.

"ë­˜ ê¸°ëŒ€í•˜ëŠ” ê±°ì§€?"

ê¹€ì •í˜¸ê°€ ë¬¼ì—ˆë‹¤.

"ëª¨ë¥´ê² ì–´."

ì œì„ìŠ¤ê°€ ë‹µí–ˆë‹¤.

ë²½ì„ ë°”ë¼ë´¤ë‹¤. ì—¬ì „íˆ ê·¸ëƒ¥ ë²½ì´ì—ˆë‹¤.

í•˜ì§€ë§Œ ê°€ë”, ì •ë§ ê°€ë”.
ë°”ëŒì´ ë¶ˆë©´.
ë¬´ì–¸ê°€ ì—´ë¦¬ëŠ” ê²ƒ ê°™ì€ ê¸°ë¶„ì´ ë“¤ì—ˆë‹¤.

ì°©ê°ì´ì—ˆë‹¤.
ë¶„ëª… ì°©ê°ì´ì—ˆë‹¤.

ê·¸ëŸ°ë°ë„ ê·¸ë“¤ì€ ë§¤ì¼ ë°¤ ì™”ë‹¤.
ê¸°ë‹¤ë ¸ë‹¤.
ë¬´ì—‡ì„ ê¸°ë‹¤ë¦¬ëŠ”ì§€ë„ ëª¨ë¥¸ ì±„.

ì–´ë””ì„ ê°€ ë°©ìš¸ ì†Œë¦¬ê°€ ë“¤ë ¸ë‹¤.
ê³ ì–‘ì´ ëª©ì— ë‹¬ë¦° ë°©ìš¸ì´ì—ˆë‹¤. ê¸¸ê³ ì–‘ì´ê°€ ì§€ë‚˜ê°”ë‹¤.
ê·¸ë¿ì´ì—ˆë‹¤.
      </div>

      <div class="row">
        <button class="btn" id="btnEnter">ë²½ì„ ë°”ë¼ë³¸ë‹¤</button>
        <button class="btn" id="btnHelp">ë„ì›€ë§</button>
      </div>
    </div>
  </section>

  <!-- HUD -->
  <section class="hud" id="hud">
    <div class="header">
      <div>
        <div class="h-title">ë™ë¬˜ ê·€ì‹œì¥</div>
        <div class="small" id="subinfo"></div>
      </div>
      <div class="row">
        <button class="btn" id="btnHelp2">ë„ì›€ë§</button>
      </div>
    </div>

    <!-- Stats / Resources -->
    <div class="statbar">
      <div class="slab">ì´ì„±<div class="v" id="sReason">3</div></div>
      <div class="slab">ê°ì •<div class="v" id="sEmp">3</div></div>
      <div class="slab">ì§ê´€<div class="v" id="sInst">3</div></div>
      <div class="slab">ì‹œê°„<div class="v" id="rTime">60</div></div>
      <div class="slab">ì •ì‹ <div class="v" id="rPsy">70</div></div>
      <div class="slab">ë‹¨ì„œ<div class="v" id="rClue">0</div></div>
    </div>
    <div class="row kv">
      <span>ì£¼í™”: <b id="rCoin">3</b></span>
      <span>ì˜ì‹¬ë„(Heat): <b id="rHeat">0</b></span>
      <span>íŒíŠ¸ ì¡°ê°: <b id="rShard">0</b></span>
      <span>ë™í–‰ ë„ì›€ ì¿¨íƒ€ì„: <b id="rCD">0</b>í„´</span>
    </div>

    <div class="panel">
      <div class="story" id="story">â€¦</div>
      <div class="choices" id="choices"></div>
    </div>

    <div class="inv" id="inv">
      <div class="small" style="margin-bottom:6px">ì†Œì§€í’ˆ</div>
      <div id="tags"></div>
    </div>
  </section>

  <!-- HELP -->
  <aside class="help" id="help">
    <div class="head">
      <div style="font-weight:800;color:#e6dbd0">ë„ì›€ë§ / ê·œì¹™ / íŠœí† ë¦¬ì–¼</div>
      <button class="btn" id="btnHelpClose">ë‹«ê¸°</button>
    </div>
    <div class="body">
      <h3 style="margin:6px 0 8px;color:#e66">í•µì‹¬ ê·œì¹™</h3>
      <p class="small">
        â€¢ ëª©í‘œ: ì´ë¦„ ì—†ëŠ” ì§„ì‹¤ì— ë‹¿ì•„ ì§€í•˜ë¡œ ë‚´ë ¤ê°€ê³ , ë§ˆì§€ë§‰ì— ì„ íƒí•˜ë¼.<br>
        â€¢ ìƒì ì€ í•œ ë²ˆ ê±°ë˜í•˜ë©´ ì ê¹ë‹ˆë‹¤. (ì²« ê±°ë˜ í›„ ì¬ì…ì¥ ë¶ˆê°€)<br>
        â€¢ ê³¨ëª©ì—ì„œ NPCÂ·ì „íˆ¬Â·ë„ë°•Â·êµí™˜ìœ¼ë¡œ <b>íŒíŠ¸ ì¡°ê°</b>ê³¼ ë‹¨ì„œë¥¼ ëª¨ìœ¼ì„¸ìš”.<br>
        â€¢ <b>íŒíŠ¸ ì¡°ê° â‰¥ 3</b> ë˜ëŠ” <b>ë‹¨ì„œ â‰¥ 4</b>ë©´ ë°”ë‹¥ ë¬¸ì–‘ì´ ë°˜ì‘ â†’ ì§€í•˜ë¡œ í•˜ê°•.<br>
        â€¢ ì‹œê°„(60)ì€ ë§¤ í–‰ë™ì— ì†Œëª¨, 0ì´ë©´ ìƒˆë²½ ì—”ë”©. ì •ì‹  0ì´ë©´ ê´‘ê¸° ì—”ë”©.<br>
        â€¢ ë²„íŠ¼ì— <span class="tip">ì„±ê³µë¥ %</span>ì´ ë³´ì…ë‹ˆë‹¤. ë™í–‰ í˜¸ì¶œ/ì•„ì´í…œìœ¼ë¡œ ë³´ì • ê°€ëŠ¥.
      </p>
      <hr class="sep">
      <h4>ëŠ¥ë ¥ì¹˜</h4>
      <p class="small">
        â€¢ <b>ì´ì„±</b>: ìˆ˜ìˆ˜ê»˜ë¼/ë¶„ì„/í•´ë… ì„±ê³µë¥ â†‘<br>
        â€¢ <b>ê°ì •</b>: ì„¤ë“/êµì„­/êµí™˜/íŠ¹ì • ìƒì  í˜¸ê° ë³´ì •â†‘<br>
        â€¢ <b>ì§ê´€</b>: ì „íˆ¬/ë„ë°•/ìœ„í—˜íšŒí”¼/í–‰ìš´ ë³´ì •â†‘
      </p>
      <h4>ë™í–‰(ì¿¨ 2í„´)</h4>
      <p class="small">
        â€¢ í˜•ì‚¬: ì „íˆ¬ +10% (ì •ì‹  -5), ì œì„ìŠ¤: ë„ë°• +10% (ì£¼í™” -1),<br>
        â€¢ ê´‘ê³ ì‚¬ì¥: êµì„­/ìˆ˜ìˆ˜ê»˜ë¼ íŒíŠ¸ (ê°ì •â‰¥4 í•„ìš”), ê¹€ì •í˜¸: ê°€ê²© -1 (ìƒì  1íšŒ)
      </p>
      <h4>ì˜ì‹¬ë„(Heat)</h4>
      <p class="small">
        â€¢ ì‹¤íŒ¨/ë¬´ë¦¬í•œ í–‰ë™ ì‹œ +1. 3/6ì— ë§¤ë³µÂ·ê°€ê²©ì¸ìƒ ë“± ë¦¬ìŠ¤í¬ ì¦ê°€.
      </p>
      <h4>ì‹œê°„ëŒ€ ìƒì </h4>
      <p class="small">
        â€¢ ì¶•ì‹œ ì´ˆë°˜ì—” 2~3ê³³, ì¤‘ë°˜ 3~4ê³³, ëìë½ 1ê³³ ë“± ê°€ë³€. í•¨ì • ìƒì  ë“±ì¥ ê°€ëŠ¥.
      </p>
      <p class="small notice">ë„ì›€ë§ì—” 'ëˆ„êµ¬'ì˜ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ê±´ ì§ì ‘ ë°í˜€ì•¼ í•©ë‹ˆë‹¤.</p>
    </div>
  </aside>

</div>

<script>
/* ---------- UTIL ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function rnd(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* ---------- STATE ---------- */
const state = {
  scene: 'title',
  floor: 'G',
  char: null,
  stats: { reason:3, empathy:3, instinct:3 },
  res: { time:60, psyche:70, clues:0, coins:3 },
  meta: { heat:0, shards:0, turn:0, cd:0, pity:{fight:0,gamble:0,riddle:0} },
  inv: [],
  visitedShops: new Set(),
  lockedShops: new Set(),
  flags: { marketSeen:false, riddleHint:false },
};

/* ---------- DATA: SHOPS ---------- */
const SHOPS = [
  {
    id:'jewel',
    name:'ì˜í˜¼ì˜ ë³´ì„ìƒ',
    type:'riddle',
    openAt:'any',
    intro: `ìœ ë¦¬ ì§„ì—´ì¥ì— ê°ì •ì´ êµ³ì–´ ì•‰ì•„ ìˆì—ˆë‹¤. íŒŒë€ë¹›ì€ ì˜¤ë˜ëœ ìš¸ìŒ, ë¶‰ì€ë¹›ì€ ì…ìˆ ì˜ í‰í„°, ì´ˆë¡ë¹›ì€ ë§ë¼ë¶™ì€ ê·¸ë¦¬ì›€.
ìƒì¸ì€ ì›ƒëŠ”ì§€ ì•„ë‹Œì§€ ì•Œ ìˆ˜ ì—†ëŠ” ëª©ì†Œë¦¬ë¡œ ë§í–ˆë‹¤. 
"ì›í•˜ëŠ” ê±´ ì•Œì£ . ê°€ì§„ ê±¸ ëª¨ë¥¼ ë¿."`,
    riddle: {
      q:`"í•œ ì™•ì´ ìˆì—ˆìŠµë‹ˆë‹¤. 
ëª¨ë“  ìŠ¬í””ì„ íŒ”ì•„ ì™•êµ­ì„ ì§€ì¼°ê³ , ëª¨ë“  ë¶„ë…¸ë¥¼ íŒ”ì•„ í‰í™”ë¥¼ ìƒ€ìœ¼ë©°, ëª¨ë“  ê·¸ë¦¬ì›€ì„ íŒ”ì•„ ë¯¸ë˜ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.
ê·¸ëŠ” ì™œ ë¬´ë„ˆì¡Œì„ê¹Œìš”?"`,
      a:[
        { key:'ì¸ê°„ì„±ì˜ ìƒì‹¤', text:'ê°ì • ì—†ëŠ” ì™•ì€ ë” ì´ìƒ ì¸ê°„ì´ ì•„ë‹ˆì—ˆë‹¤', effect:()=>{ gain('clues',2); pushInv('ì§€í˜œì˜ ì¡°ê°'); msg('ìƒì¸ì€ ê³ ê°œë¥¼ ë„ë•ì˜€ë‹¤. "ê»ë°ê¸°ëŠ” ì˜¤ë˜ ëª» ê°‘ë‹ˆë‹¤." (ë‹¨ì„œ+2)'); } , pref:true },
        { key:'ë°±ì„±ì˜ ì´íƒˆ', text:'ë°±ì„±ë“¤ì´ ê°ì • ì—†ëŠ” ì™•ì„ ë”°ë¥´ì§€ ì•Šì•˜ë‹¤', effect:()=>{ gain('clues',1); msg('"ë°˜ì¯¤ì€ìš”."(ë‹¨ì„œ+1)'); } },
        { key:'ê¸°ì–µì˜ ì”ì¡´', text:'ê°ì •ì„ íŒ”ì•„ë„ ê¸°ì–µì€ ë‚¨ì•˜ë‹¤', effect:()=>{ state.stats.reason++; msg('"í¥ë¯¸ë¡œìš´ ê´€ì°°." (ì´ì„±+1)'); } }
      ]
    },
    items:[
      {name:'ìŠ¬í””ì˜ ì‚¬íŒŒì´ì–´', cost:{coins:2, psyche:10,time:6}, lore:'ìš¸ì§€ ëª»í•˜ëŠ” í‰ì˜¨. ë‹¨, ì˜¤ë˜ ë³´ë©´ ì°¨ê°‘ë‹¤.', effect:()=>{ pushInv('ìŠ¬í””ì˜ ì‚¬íŒŒì´ì–´'); state.flags.riddleHint=true; }},
      {name:'ë¶„ë…¸ì˜ ë£¨ë¹„', cost:{coins:2, psyche:5,time:6}, lore:'ë¶ˆë¡œ ì¥” ì •ì˜. ë‹¨, ì†ë°”ë‹¥ì´ íƒ„ë‹¤.', effect:()=>{ pushInv('ë¶„ë…¸ì˜ ë£¨ë¹„'); }},
      {name:'ê·¸ë¦¬ì›€ì˜ ì—ë©”ë„ë“œ', cost:{coins:1, psyche:8,time:6}, lore:'ë’¤ëŒì•„ë³´ì§€ ì•Šê²Œ í•´ì¤€ë‹¤. ëŒ€ì‹  ë‚´ì¼ì´ íë¦¿í•´ì§„ë‹¤.', effect:()=>{ pushInv('ê·¸ë¦¬ì›€ì˜ ì—ë©”ë„ë“œ'); }},
      {name:'í›„íšŒì˜ ë‹¤ì´ì•„ëª¬ë“œ', cost:{coins:3, psyche:12,time:8}, lore:'ê²°ì •ì„ ë˜ì§šê²Œ í•œë‹¤. ë‹¨, ë˜ëŒë¦´ ìˆ˜ ì—†ëŠ” ê²ƒë§Œ ì„ ëª…í•´ì§„ë‹¤.', effect:()=>{ pushInv('í›„íšŒì˜ ë‹¤ì´ì•„ëª¬ë“œ'); }}
    ],
  },
  { id:'memory', name:'ê¸°ì–µì—„ìƒ‰ì†Œ', type:'trade', openAt:'any',
    intro:`í—ˆì—° ëˆˆë™ìì˜ ë…¸íŒŒ. ë¹„ë‹¨ì£¼ë¨¸ë‹ˆ ì…‹ì„ êº¼ë‚´ë©° ì¤‘ì–¼ê±°ë ¸ë‹¤. "ìŠì€ ì¤„ ì•Œì•˜ë˜ ê²ƒ, ìŠê³  ì‹¶ì—ˆë˜ ê²ƒ, ìŠì–´ì•¼ í–ˆë˜ ê²ƒ."`,
    items:[
      {name:'ì²«ì‚¬ë‘ì˜ ë§ˆì§€ë§‰ ì¸ì‚¬', cost:{coins:1,time:5,psyche:6}, lore:'ë”°ëœ»í•˜ì§€ë§Œ ì˜¤ë˜ ë³´ê´€í•˜ë©´ íë ¤ì§„ë‹¤.', effect:()=>{ pushInv('ì²«ì‚¬ë‘ì˜ ë§ˆì§€ë§‰ ì¸ì‚¬'); addShard(1); gain('clues',1); }},
      {name:'ê¹¨ë—í–ˆë˜ ë§ˆìŒ', cost:{coins:2,time:6,psyche:8}, lore:'ì ê¹ì˜ ìš©ê¸°. ë‹¤ìŒ ì„ íƒì´ ë¬´ê±°ì›Œì§„ë‹¤.', effect:()=>{ pushInv('ê¹¨ë—í–ˆë˜ ë§ˆìŒ'); addShard(1); gain('clues',1); }},
      {name:'í¬ë¯¸í•œ ì´ë¦„ ìª½ì§€', cost:{coins:1,time:5}, lore:'ë¬¼ì— ë²ˆì§„ í•„ê¸°ì²´. ììŒ í•˜ë‚˜ê°€ ë‚¨ëŠ”ë‹¤.', effect:()=>{ pushInv('ìª½ì§€(ììŒ)'); addShard(1); }}
    ]
  },
  { id:'reassemble', name:'ê³¼ê±° ì¬ì¡°ë¦½ì ', type:'trade', openAt:'any',
    intro:`ë‚˜ë¬´ìƒ ìœ„ì— ë¶„í•´ëœ íšŒì¤‘ì‹œê³„. ì£¼ì¸ì€ íƒœì—½ì„ ë“¤ì–´ ë³´ì´ë©° ë§í–ˆë‹¤. "ë¹ ì§„ ê±´ ëŠ˜ ì œì¼ ì‘ì€ ê±°ì§€."`,
    items:[
      {name:'íƒœì—½ ì¡°ê°', cost:{coins:1,time:5}, lore:'ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠëŠ” ì¡°ê°. ê·¸ëŸ¬ë‚˜ ì—†ëŠ” ê²ƒë³´ë‹¨ ë‚«ë‹¤.', effect:()=>{ pushInv('íƒœì—½ ì¡°ê°'); addShard(1);} },
      {name:'ë‚¡ì€ ë‚˜ì‚¬ëª»', cost:{coins:1,time:4}, lore:'êµ¬ë©ì´ í—ê±°ìš´ ê¸°ì–µì— ë°•ëŠ”ë‹¤.', effect:()=>{ pushInv('ë‚¡ì€ ë‚˜ì‚¬ëª»'); }},
      {name:'ë¯¸ì„¸í•œ ìŠ¤í”„ë§', cost:{coins:1,time:4}, lore:'íŒ½íŒ½í• ìˆ˜ë¡ ì˜ ëŠì–´ì§„ë‹¤.', effect:()=>{ pushInv('ë¯¸ì„¸í•œ ìŠ¤í”„ë§'); }}
    ]
  },
  { id:'desire', name:'ìš•ë§ ë§¤ì…ì†Œ', type:'trade', openAt:'mid',
    intro:`ë¶‰ì€ í–¥ì´ ì½”ë¥¼ ì°”ë €ë‹¤. "ë¬´ì—‡ì„ ìƒê³  ì‹¶ìœ¼ì‹ ê°€ìš”?"`,
    items:[
      {name:'ê°€ë²¼ìš´ ì–‘ì‹¬', cost:{psyche:10,time:6}, lore:'ì£„ì±…ê°ì´ ëœ ë¬´ê²ë‹¤. ëŒ€ì‹  ì˜ì‹¬ì´ ë¹¨ë¦¬ ë¶™ëŠ”ë‹¤.', effect:()=>{ pushInv('ê°€ë²¼ìš´ ì–‘ì‹¬'); state.meta.heat++; }},
      {name:'ëˆ ëƒ„ìƒˆ', cost:{coins:1,time:4}, lore:'ì „ë¶€ê°€ ê·¸ ëƒ„ìƒˆë¡œ ë³´ì¸ë‹¤.', effect:()=>{ pushInv('ëˆ ëƒ„ìƒˆ'); }}
    ]
  },
  { id:'post', name:'ë§ìì˜ ìš°ì²´êµ­', type:'trade', openAt:'late',
    intro:`ê³µì¤‘ì— í¸ì§€ë“¤ì´ ë– ë‹¤ë…”ë‹¤. ìš°ì²´êµ­ì¥ì€ ì´ë¯¸ ì˜¤ë˜ì „ì— ì£½ì€ ë“¯í–ˆë‹¤. "ëˆ„êµ¬ì—ê²Œ ë³´ë‚¼ê¹Œìš”?"`,
    items:[
      {name:'ì‚¬ì£„ì˜ í¸ì§€', cost:{time:6,psyche:8}, lore:'ë‹µì€ ì˜¤ì§€ ì•ŠëŠ”ë‹¤. ë§ˆìŒì€ ê°€ë²¼ì›Œì§„ë‹¤.', effect:()=>{ pushInv('ì‚¬ì£„ì˜ í¸ì§€'); gain('clues',1);} },
      {name:'ì§ˆë¬¸ì˜ í¸ì§€', cost:{time:6,coins:1}, lore:'ê°€ë” ë‹µì¥ì´ ì˜¨ë‹¤. ëŒ€ê°œëŠ” ëŠ¦ë‹¤.', effect:()=>{ pushInv('ì§ˆë¬¸ì˜ í¸ì§€'); if(Math.random()<0.4){ addShard(1); msg('ëŠë¦° ë‹µì¥: íŒíŠ¸ ì¡°ê° +1'); }} }
    ]
  }
];

/* ---------- MARKET ROLL ---------- */
function openMarket(){
  state.scene='market';
  
  // ê²Œì„ ì¢…ë£Œ ì²´í¬
  if (state.res.time <= 0) {
    return endingDawn();
  }
  if (state.res.psyche <= 0) {
    return endingMadness();
  }
  
  // ì‹œê°„ëŒ€ì— ë”°ë¥¸ ìƒì  ìˆ˜
  const t = state.res.time;
  let count = 3;
  if (t>45) count = 2 + rnd(0,1);
  else if (t>20) count = 3 + rnd(0,1);
  else count = 1 + rnd(0,1);

  const pool = SHOPS.filter(s=>{
    if (state.lockedShops.has(s.id)) return false;
    if (state.visitedShops.has(s.id)) return true;
    if (s.openAt==='mid' && t>40) return false;
    if (s.openAt==='late' && t>25) return false;
    return true;
  });

  const options = shuffle(pool).slice(0, Math.max(1, Math.min(count, pool.length)));

  setText(`ìƒì ë“¤ì„ ë°”ë¼ë³¸ë‹¤.

ë¶‰ì€ ë“±ë¶ˆ ì•„ë˜, í”¼ë¡œ ì“´ ê°„íŒë“¤ì´ ë¯¸ì„¸í•˜ê²Œ ë–¨ë¦°ë‹¤.
ì†ìœ¼ë¡œ ê·¸ë¦° ê¸€ì”¨, ë²ˆì§„ ì‰í¬, ê¸ˆë¹› ë‚˜ë¹„ ë‚ ê°œ ì¥ì‹â€”.

ì–´ë””ë¡œ ë“¤ì–´ê°ˆê¹Œ?`);
  const ch=[];
  options.forEach(s=>{
    ch.push({text:`ğŸ›ï¸ ${s.name}`, fn:()=>enterShop(s.id)});
  });
  ch.push({text:`ğŸ” ê³¨ëª©ìœ¼ë¡œ ë‚˜ê°€ ë³¸ë‹¤ (ì‹œê°„ -4)`, fn:()=>{ spend({time:4}); alley(); }});
  
  // í•˜ê°• ê²Œì´íŠ¸
  if (state.meta.shards>=3 || state.res.clues>=4){
    ch.push({text:`â¬‡ï¸ ë°”ë‹¥ ë¬¸ì–‘ì´ ë¯¸ì„¸í•˜ê²Œ ë¹›ë‚œë‹¤ (ì§€í•˜ë¡œ ë‚´ë ¤ê°„ë‹¤ Â· ì‹œê°„ -8)`, fn:()=>{ spend({time:8}); descendB1(); }});
  } else {
    const needShards = 3 - state.meta.shards;
    const needClues = 4 - state.res.clues;
    ch.push({text:`âŒ ë°”ë‹¥ ë¬¸ì–‘ì´ ë°˜ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ (íŒíŠ¸ ì¡°ê° ${needShards}ê°œ ë˜ëŠ” ë‹¨ì„œ ${needClues}ê°œ ë” í•„ìš”)`, fn:()=>{ 
      msg('ë¬¸ì–‘ì´ í¬ë¯¸í•˜ê²Œ ê¹œë¹¡ì´ë‹¤ êº¼ì¡Œë‹¤. ì•„ì§ ë¶€ì¡±í•˜ë‹¤.'); 
    }});
  }
  
  // ê¸´ê¸‰ íƒˆì¶œ
  if (t <= 15 || state.res.psyche <= 20) {
    ch.push({text:`ğŸšª í¬ê¸°í•˜ê³  í˜„ì‹¤ë¡œ ëŒì•„ê°„ë‹¤ (ê²Œì„ ì¢…ë£Œ)`, fn:()=>{ 
      endingGiveUp(); 
    }});
  }
  
  setChoices(ch);
}

/* ---------- SHOP ---------- */
function enterShop(id){
  const s = SHOPS.find(x=>x.id===id);
  if (!s) return;
  if (state.lockedShops.has(id)){
    setText(`${s.name}\n\në¬¸ì´ êµ³ê²Œ ì ê²¼ë‹¤. "í•œ ì˜í˜¼, í•œ ë²ˆ."`);
    setChoices([{text:'ëŒì•„ê°„ë‹¤', fn:openMarket}]);
    return;
  }
  state.visitedShops.add(id);

  if (s.type==='riddle'){
    setText(`${s.name}\n\n${s.intro}\n\n${s.riddle.q}`);
    const base = baseChance('riddle');
    const hint = state.flags.riddleHint || state.stats.empathy>=4;
    const ch = s.riddle.a.map(opt=>{
      const p = clamp(base + (opt.pref? +10:0) + (hint? +10:0), 15, 95);
      return {text:`${opt.text}  <span class="prob">ì„±ê³µ ${p}%</span>`, fn:()=>roll(p,
        ()=>{ opt.effect(); afterRiddle(s); },
        ()=>{ failMark('riddle'); heatUp(1); msg('ìƒì¸ì€ ê³ ê°œë¥¼ ì “ëŠ”ë‹¤. "ê·¸ ëŒ€ë‹µìœ¼ë¡  ëª» ì‚½ë‹ˆë‹¤."'); afterRiddle(s); }
      )};
    });
    setChoices([...ch, {text:'ë‚˜ê°„ë‹¤', fn:openMarket}]);
  } else {
    setText(`${s.name}\n\n${s.intro}\n\nì§„ì—´ëŒ€ë¥¼ í›‘ëŠ”ë‹¤.`);
    const ch=[];
    s.items.forEach(it=>{
      const costTxt = costToText(it.cost);
      ch.push({text:`${it.name} â€” ${costTxt}\n<span class="small">${it.lore}</span>`, fn:()=>buyItem(s,it)});
    });
    ch.push({text:'ë‚˜ê°„ë‹¤', fn:openMarket});
    setChoices(ch);
  }
}

function afterRiddle(s){
  const ch = s.items.map(it=>({text:`êµ¬ë§¤: ${it.name} â€” ${costToText(it.cost)}\n<span class="small">${it.lore}</span>`, fn:()=>buyItem(s,it)}));
  ch.push({text:'ë‚˜ê°„ë‹¤', fn:openMarket});
  setChoices(ch);
}

function buyItem(shop, it){
  if (!canPay(it.cost)){ msg('ëŒ€ê°€ê°€ ë¶€ì¡±í•˜ë‹¤.'); return; }
  pay(it.cost);
  it.effect && it.effect();
  state.lockedShops.add(shop.id);
  msg(`ê±°ë˜ê°€ ëë‚˜ì ì§„ì—´ì¥ì˜ ë¶ˆë¹›ì´ í•˜ë‚˜ì”© êº¼ì¡Œë‹¤. (${shop.name} ì ê¹€)`);
  updateHUD();
  setChoices([{text:'ê³¨ëª©ìœ¼ë¡œ ë‚˜ê°„ë‹¤', fn:openMarket}]);
}

/* ---------- ALLEY ---------- */
function alley(){
  state.scene='alley';
  const roll = Math.random();
  if (roll<0.34) return npcEncounter();
  if (roll<0.67) return lightFight();
  return gambling();
}

function npcEncounter(){
  setText(`ê³¨ëª©. ë“±ë¶ˆì´ ì—†ëŠ” ì–´ë‘  ìª½ì—ì„œ ì†ì´ ë‚˜ì™€ ì†Œë§¤ë¥¼ ì¡ëŠ”ë‹¤.

"ì´ê±° ì°¾ëŠ” ê±° ì•„ë‹ˆì—ˆì–´?"`);
  const base = baseChance('talk');
  const p = clamp(base + state.stats.empathy*6 - state.meta.heat*5, 10, 95);
  const useAd = (state.stats.empathy>=4);
  const ch = [
    {text:`ì„¤ë“í•´ ë³¸ë‹¤ <span class="prob">ì„±ê³µ ${p}%</span>`, fn:()=>roll(p,
      ()=>{ addShard(1); gain('clues',1); msg('ë…¸íŒŒê°€ ë¹„ë‹¨ì£¼ë¨¸ë‹ˆë¥¼ ì¥ì—¬ì¤€ë‹¤. (íŒíŠ¸ ì¡°ê°+1, ë‹¨ì„œ+1)'); openMarket(); },
      ()=>{ heatUp(1); losePsy(6); msg('"ê·¸ ëˆˆë¹›ì´ ì‹«ì–´." ì†ì´ ì‚¬ë¼ì¡Œë‹¤. (ì˜ì‹¬ë„+1, ì •ì‹ -6)'); openMarket(); }
    )},
  ];
  
  if (state.char !== 'ê´‘ê³ ì‚¬ì¥' && useAd) {
    ch.push({text:`ê´‘ê³ ì‚¬ì¥ì—ê²Œ ë§ì„ ê±¸ì–´ë‹¬ë¼ê³  í•œë‹¤ (ê°ì •â‰¥4, ì¿¨ 2í„´)`, fn:()=>callCompanion('ad', ()=>{ 
      addShard(1); 
      msg('"ë§ì€ ì´ë ‡ê²Œ ë‹¤ëŠ” ê±°ì•¼." ê´‘ê³ ì‚¬ì¥ì´ ëŠ¥ìˆ™í•˜ê²Œ ëŒ€í™”ë¥¼ ì´ëŒì—ˆë‹¤. (íŒíŠ¸ ì¡°ê°+1)'); 
      openMarket(); 
    })});
  }
  
  if (state.char !== 'ì œì„ìŠ¤') {
    ch.push({text:`ì œì„ìŠ¤ì—ê²Œ í˜‘ìƒì„ ë§¡ê¸´ë‹¤ (ì£¼í™” -1, ì¿¨ 2í„´)`, fn:()=>callCompanion('james', ()=>{ 
      gain('clues', 1);
      msg('"ì´ëŸ° ê±´ ë‚´ ì „ë¬¸ì´ì§€." ì œì„ìŠ¤ê°€ ëŠ¥ìˆ™í•˜ê²Œ êµì„­í–ˆë‹¤. (ë‹¨ì„œ+1)'); 
      openMarket(); 
    })});
  }
  
  ch.push({text:'ê·¸ëƒ¥ ì§€ë‚˜ì¹œë‹¤ (ì‹œê°„ -3)', fn:()=>{ spend({time:3}); openMarket(); }});
  setChoices(ch);
}

function lightFight(){
  setText(`êµ¬ì„ì—ì„œ ë°œì†Œë¦¬. ê·¸ë¦¼ìê°€ ë‹¬ë ¤ë“ ë‹¤.`);
  const base = baseChance('fight');
  let p = base + state.stats.instinct*6 - state.meta.heat*5;
  if (has('ë¶„ë…¸ì˜ ë£¨ë¹„') && has('íƒœì—½ ì¡°ê°')) p += 15;
  p = clamp(p, 10, 95);
  const ch = [
    {text:`ëŒ€ì‘í•œë‹¤ <span class="prob">ì„±ê³µ ${p}%</span>`, fn:()=>roll(p,
      ()=>{ gain('coins',1); msg('ì£¼ë¨¸ë‹ˆì—ì„œ ë‚¡ì€ ì£¼í™”ê°€ êµ´ëŸ¬ë‚˜ì™”ë‹¤. (ì£¼í™”+1)'); openMarket(); },
      ()=>{ heatUp(1); losePsy(8); msg('ì‹¸ëŠ˜í•œ ë¬´ì–¸ê°€ê°€ íŒ”ì„ ìŠ¤ì³¤ë‹¤. (ì •ì‹ -8, ì˜ì‹¬ë„+1)'); openMarket(); }
    )}
  ];
  
  if (state.char !== 'ë¹„ë¦¬í˜•ì‚¬') {
    ch.push({text:`í˜•ì‚¬ì—ê²Œ ë„ì›€ì„ ìš”ì²­í•œë‹¤ (ì •ì‹  -5, ì¿¨ 2í„´, ì„±ê³µ+10%)`, fn:()=>callCompanion('cop', ()=>{
      let q = clamp(p+10,10,95);
      roll(q, ()=>{ gain('coins',1); msg('í˜•ì‚¬ê°€ ì¡°ìš©íˆ ì œì••í–ˆë‹¤. (ì£¼í™”+1)'); openMarket(); },
                 ()=>{ heatUp(1); losePsy(6); msg('"ë‹¤ìŒì—” í”¼í•˜ë¼ë‹ˆê¹Œ." (ì •ì‹ -6, ì˜ì‹¬ë„+1)'); openMarket(); });
    })});
  }
  ch.push({text:'ë„ë§ì¹œë‹¤ (ì‹œê°„ -4)', fn:()=>{ spend({time:4}); heatUp(1); openMarket(); }});
  setChoices(ch);
}

function gambling(){
  setText(`í—ˆë¦„í•œ ë…¸ì â€”ì»µ ì„¸ ê°œê°€ ì‰­ì‰­ ì›€ì§ì¸ë‹¤. "ë§íˆë©´ ë‘ ë°°."`);
  const base = baseChance('gamble');
  let p = clamp(base + state.stats.reason*5 - lossStreak('gamble')*5, 10, 90);
  const ch = [
    {text:`ì£¼í™” 1ê°œ ë² íŒ… <span class="prob">ì„±ê³µ ${p}%</span>`, fn:()=>bet(1,p)},
  ];
  
  if (state.char !== 'ì œì„ìŠ¤') {
    ch.push({text:`ì œì„ìŠ¤ì˜ ë„ì›€ì„ ë°›ëŠ”ë‹¤ (ì£¼í™” -1, ì¿¨ 2í„´, ì„±ê³µ+10%)`, fn:()=>callCompanion('james', ()=>{
      bet(1, clamp(p+10,10,95), true);
    })});
  }
  
  if (state.char !== 'ê¹€ì •í˜¸') {
    ch.push({text:`ê¹€ì •í˜¸ì—ê²Œ í¥ì •ì„ ë¶€íƒí•œë‹¤ (ì¿¨ 2í„´, ë² íŒ…ì•¡ í• ì¸)`, fn:()=>callCompanion('kim', ()=>{
      if (state.res.coins >= 1) {
        roll(p, 
          ()=>{ state.res.coins += 2; pityReset('gamble'); msg(`ê¹€ì •í˜¸ê°€ í¥ì •í–ˆë‹¤. "ì´ ì •ë„ë©´ ê´œì°®ì§€?" (ì£¼í™”+2)`); openMarket(); },
          ()=>{ pityUp('gamble'); heatUp(1); losePsy(4); msg('ê¹€ì •í˜¸ë„ ëª» ë§‰ì•˜ë‹¤. (ì •ì‹ -4, ì˜ì‹¬ë„+1)'); openMarket(); }
        );
      } else {
        msg('ì£¼í™”ê°€ ë¶€ì¡±í•˜ë‹¤.');
      }
    })});
  }
  
  ch.push({text:`ê·¸ë§Œë‘”ë‹¤ (ì‹œê°„ -2, ì˜ì‹¬ë„ -1)`, fn:()=>{ spend({time:2}); heatDown(1); openMarket(); }});
  setChoices(ch);
}

function bet(amount, p, paid){
  if (state.res.coins<amount){ msg('ì£¼í™”ê°€ ë¶€ì¡±í•˜ë‹¤.'); return; }
  if (!paid) state.res.coins -= amount;
  roll(p,
    ()=>{ state.res.coins += amount*2; pityReset('gamble'); msg(`ë‚™ì°°ì²˜ëŸ¼ ê°€ë³ê²Œ ë“¤ì–´ì˜¬ëë‹¤. (ì£¼í™”+${amount})`); openMarket(); },
    ()=>{ pityUp('gamble'); heatUp(1); losePsy(4); msg('ì»µ ë°‘ì€ í…… ë¹„ì—ˆë‹¤. (ì •ì‹ -4, ì˜ì‹¬ë„+1)'); openMarket(); }
  ); updateHUD();
}

/* ---------- DESCENT ---------- */
function descendB1(){
  state.floor='B1';
  setText(`ë°”ë‹¥ ë¬¸ì–‘ì˜ íŒŒë€ë¹›ì´ ì»¤ì¡Œë‹¤. ê¿€ì²˜ëŸ¼ ë¬´ê±°ìš´ ê³µê¸°ê°€ ê°€ë¼ì•‰ëŠ”ë‹¤.
ê³„ë‹¨ì€ ë³´ì´ì§€ ì•Šì•˜ì§€ë§Œ, ì•„ë˜ë¡œ ë‚´ë ¤ê°€ê³  ìˆì—ˆë‹¤.`);
  setChoices([
    {text:'ì–´ë‘  ì†ìœ¼ë¡œ í•œ ë°œ (ì‹œê°„ -3)', fn:()=>{ spend({time:3}); b1Hub(); }}
  ]);
}

function b1Hub(){
  setText(`ì§€í•˜ 1ì¸µ. ì†ŒìŒì´ ë©€ë‹¤. ìƒì  ê°„íŒì€ ë” ì™œê³¡ë˜ì—ˆë‹¤.

ì—¬ê¸°ì„œëŠ” ë” ì´ìƒ ì˜¤ë˜ ë¨¸ë¬´ë¥¼ ìˆ˜ ì—†ë‹¤â€”.`);
  const ch=[];
  ch.push({text:'ìƒì ë“¤ì„ ì‚´í•€ë‹¤', fn:openMarket});
  ch.push({text:'ê³¨ëª©ìœ¼ë¡œ ë‚˜ê°€ ë³¸ë‹¤ (ì‹œê°„ -5)', fn:()=>{ spend({time:5}); alley(); }});
  setChoices(ch);
}

/* ---------- CHANCE CORE ---------- */
function baseChance(kind){
  let b=40;
  if (kind==='fight') b=35;
  if (kind==='gamble') b=45;
  if (kind==='talk' || kind==='riddle') b=40;
  b += Math.min(20, lossStreak(kind)*10);
  return b;
}

function roll(p, onSuccess, onFail){
  state.meta.turn++;
  const r = Math.random()*100;
  if (r < p){ onSuccess&&onSuccess(); }
  else { onFail&&onFail(); }
  updateHUD();
  const sh = state.meta.shards;
  if ([2,5,8].includes(sh)) { msg('ì–´ë”˜ê°€ì—ì„œ ë°©ìš¸ ì†Œë¦¬. í™”ë©´ ê°€ì¥ìë¦¬ê°€ ë¶‰ì–´ì§„ë‹¤.'); }
  cdTick();
}

function lossStreak(kind){ return clamp(state.meta.pity[kind]||0,0,2); }
function pityUp(kind){ state.meta.pity[kind] = clamp((state.meta.pity[kind]||0)+1,0,2); }
function pityReset(kind){ state.meta.pity[kind]=0; }
function failMark(kind){ pityUp(kind); }

/* ---------- COMPANIONS ---------- */
function getCompanions(){
  const all = ['ê¹€ì •í˜¸', 'ì œì„ìŠ¤', 'ê´‘ê³ ì‚¬ì¥', 'ë¹„ë¦¬í˜•ì‚¬'];
  return all.filter(n => n !== state.char);
}

function callCompanion(who, cb){
  if (state.meta.cd>0){ 
    msg('ë™í–‰ë“¤ì´ ìˆ¨ ê³ ë¥´ëŠ” ì¤‘ì´ë‹¤. (ì¿¨íƒ€ì„ '+state.meta.cd+'í„´)'); 
    return; 
  }
  
  if (who==='ad' && state.stats.empathy<4){ 
    msg('ê°ì •ì´ ë¶€ì¡±í•´ ê´‘ê³ ì‚¬ì¥ì´ ë§ë¬¸ì„ íŠ¸ì§€ ëª»í•œë‹¤. (ê°ì •â‰¥4 í•„ìš”)'); 
    return; 
  }
  
  if (who==='james'){
    if (state.res.coins<1){ 
      msg('ì œì„ìŠ¤ì—ê²Œ ë„£ì–´ì¤„ ì£¼í™”ê°€ ì—†ë‹¤.'); 
      return; 
    }
    state.res.coins -= 1;
  }
  
  if (who==='cop'){ 
    losePsy(5); 
  }
  
  state.meta.cd=2;
  cb&&cb();
  updateHUD();
}

function getCompanionName(id){
  const names = {
    'cop': 'ë¹„ë¦¬í˜•ì‚¬',
    'james': 'ì œì„ìŠ¤', 
    'ad': 'ê´‘ê³ ì‚¬ì¥',
    'kim': 'ê¹€ì •í˜¸'
  };
  return names[id] || 'ì•Œ ìˆ˜ ì—†ìŒ';
}

function cdTick(){ if (state.meta.cd>0) state.meta.cd--; }

/* ---------- ECON ---------- */
function canPay(cost={}){
  const c = cost;
  if ((c.coins||0) > state.res.coins) return false;
  if ((c.time||0) > state.res.time) return false;
  if ((c.psyche||0) > state.res.psyche) return false;
  return true;
}

function pay(cost={}){
  for (const k in cost){
    if (k==='coins') state.res.coins -= cost[k];
    if (k==='time') state.res.time -= cost[k];
    if (k==='psyche') state.res.psyche -= cost[k];
  }
  updateHUD();
}

function spend(delta){ pay(delta); }
function gain(k, v){ state.res[k]+=v; updateHUD(); }
function losePsy(v){ state.res.psyche = Math.max(0, state.res.psyche - v); updateHUD(); }
function heatUp(v){ state.meta.heat = clamp(state.meta.heat+v,0,9); updateHUD(); }
function heatDown(v){ state.meta.heat = clamp(state.meta.heat-v,0,9); updateHUD(); }
function pushInv(name){ state.inv.push(name); renderInv(); updateHUD(); }
function has(name){ return state.inv.includes(name); }
function addShard(v){ state.meta.shards += v; renderInv(); updateHUD(); }

function costToText(c){
  const arr=[];
  if (c.coins) arr.push(`ì£¼í™”-${c.coins}`);
  if (c.psyche) arr.push(`ì •ì‹ -${c.psyche}`);
  if (c.time) arr.push(`ì‹œê°„-${c.time}`);
  return arr.join(', ');
}

/* ---------- UI CORE ---------- */
function setText(t){ $('#story').textContent=t; }

function setChoices(list){
  const box = $('#choices'); 
  box.innerHTML='';
  
  list.forEach(it=>{
    const b = document.createElement('button'); 
    b.className = 'choice';
    b.innerHTML = it.text;
    
    // ë‹¨ìˆœí•˜ê²Œ onclick ì‚¬ìš© (ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ëª¨ë‘ ì§€ì›)
    b.onclick = function() {
      it.fn();
    };
    
    box.appendChild(b);
  });
}

function renderInv(){
  const invBox = $('#inv'); 
  const tags = $('#tags'); 
  tags.innerHTML='';
  const all = [...state.inv];
  if (state.meta.shards>0) all.push(`íŒíŠ¸ ì¡°ê° Ã—${state.meta.shards}`);
  if (all.length){ invBox.classList.add('on'); }
  else { invBox.classList.remove('on'); }
  all.forEach(n=>{
    const s=document.createElement('span'); 
    s.className='tag'; 
    s.textContent=n; 
    tags.appendChild(s);
  });
}

function updateHUD(){
  $('#sReason').textContent = state.stats.reason;
  $('#sEmp').textContent = state.stats.empathy;
  $('#sInst').textContent = state.stats.instinct;
  $('#rTime').textContent = state.res.time;
  $('#rPsy').textContent = state.res.psyche;
  $('#rClue').textContent = state.res.clues;
  $('#rCoin').textContent = state.res.coins;
  $('#rHeat').textContent = state.meta.heat;
  $('#rShard').textContent = state.meta.shards;
  $('#rCD').textContent = state.meta.cd;
  $('#subinfo').textContent = `${state.char? state.char+' Â· ':''}${state.floor}ì¸µ Â· í„´ ${state.meta.turn}`;
}

/* ---------- FLOW ---------- */
function startPrologue(){
  $('#title').style.display='none';
  $('#hud').classList.add('on');
  updateHUD();
  
  setText(`ê·¸ ìˆœê°„,
ëª¨ë“  í˜„ì‹¤ì€ ì‚¬ë¼ì¡Œë‹¤.

ì „ë¬´ëŠ” ë™ë¬˜ ì‚¬ë‹¹ ì•ˆìœ¼ë¡œ ë°œì„ ë‚´ë””ë ë‹¤.
ê³µê¸°ê°€ ë¬´ë„ˆì¡Œë‹¤. ê¿€ì²˜ëŸ¼ ë¬´ê²ê³  í˜€ëì—ì„  ì‡ ë§›.

ë¨¸ë¦¬ ìœ„ë¡œ ê²€ì€/ë¶‰ì€/ê¸ˆë¹› ì‹¤íƒ€ë˜ê°€ í•˜ëŠ˜ ëŒ€ì‹  ì–½í˜€ ìˆê³ ,
ê·¸ ì‚¬ì´ë¡œ ì£¼í™ë¹› ë“±ë¶ˆë“¤ì´ ë‘¥ë‘¥ ë– ë‹¤ë‹ˆë©°
ì§€ë‚˜ê°€ëŠ” ì‚¬ëŒë“¤ì˜ ê·¸ë¦¼ìë¥¼ ë”°ë¼ê°”ë‹¤.

"ìš•ë§ ë§¤ì…ì†Œ."
"ë¯¸ë˜ ë„ìƒ‰ì†Œ."
"ê³¼ê±° ì¬ì¡°ë¦½ì ."
"ì£½ìŒ ì„ëŒ€ì†Œ."

ë‘êº¼ìš´ ë²½ëŒ ë°”ë‹¥, ì¶•ì¶•í•œ ê°ì´‰.
ì›í˜• ë¬¸ì–‘ì´ í¬ë¯¸í•œ íŒŒë€ë¹›ì„ í˜ë¦¬ê³  ìˆì—ˆë‹¤.

â€¦ë‚˜ëŠ” ëˆ„êµ¬ì§€?`);
  
  setChoices([
    {text:'ê¸°ì–µì„ ë”ë“¬ëŠ”ë‹¤ â€” ê¹€ì •í˜¸(ì‚¬ì—…ê°€)', fn:()=>pickChar('ê¹€ì •í˜¸', {reason:+1})},
    {text:'ê¸°ì–µì„ ë”ë“¬ëŠ”ë‹¤ â€” ì œì„ìŠ¤(ê¸°íšì‹¤ì¥)', fn:()=>pickChar('ì œì„ìŠ¤', {reason:+1})},
    {text:'ê¸°ì–µì„ ë”ë“¬ëŠ”ë‹¤ â€” ê´‘ê³ ëŒ€í–‰ì‚¬ ì‚¬ì¥', fn:()=>pickChar('ê´‘ê³ ì‚¬ì¥', {empathy:+1})},
    {text:'ê¸°ì–µì„ ë”ë“¬ëŠ”ë‹¤ â€” ë¹„ë¦¬í˜•ì‚¬', fn:()=>pickChar('ë¹„ë¦¬í˜•ì‚¬', {instinct:+1})},
  ]);
}

function pickChar(name, bonus){
  state.char=name;
  if (bonus.reason) state.stats.reason++;
  if (bonus.empathy) state.stats.empathy++;
  if (bonus.instinct) state.stats.instinct++;
  updateHUD();
  
  const companions = getCompanions();
  setText(`ë‚˜ëŠ” ${name}ì´ë‹¤.

ë’¤ì—ì„œ ì„¸ ëª…ì˜ ê·¸ë¦¼ìê°€ ë”°ë¼ë¶™ëŠ”ë‹¤.
${companions[0]}, ${companions[1]}, ${companions[2]}.

ìš°ë¦¬ëŠ” í•¨ê»˜ ë“¤ì–´ì™”ë‹¤.
í•„ìš”í•  ë•Œ ê·¸ë“¤ì˜ ë„ì›€ì„ ìš”ì²­í•  ìˆ˜ ìˆë‹¤.

ë“±ë¶ˆì´ í”ë“¤ë¦¬ë©° ê¸¸ì´ ë²Œì–´ì¡Œë‹¤.`);
  
  setChoices([{text:'ìƒì ë“¤ì„ ë°”ë¼ë³¸ë‹¤', fn:openMarket}]);
}

/* ---------- ENDINGS ---------- */
function endingDawn(){
  setText(`ìƒˆë²½ì´ ì™”ë‹¤.

ë™ì´ íŠ¸ì ê·€ì‹œì¥ì€ ì‚¬ë¼ì¡Œë‹¤.
ìƒì ë“¤ì€ ì—°ê¸°ì²˜ëŸ¼ í©ì–´ì§€ê³ , ë“±ë¶ˆì€ êº¼ì¡Œë‹¤.
ë‚˜ëŠ” ë™ë¬˜ ì‚¬ë‹¹ ì•ì— ì„œ ìˆì—ˆë‹¤.

í‰ë²”í•œ ì•„ì¹¨. í‰ë²”í•œ ê±°ë¦¬.
ì•„ë¬´ ì¼ë„ ì—†ì—ˆë˜ ê²ƒì²˜ëŸ¼.

í•˜ì§€ë§Œ ì£¼ë¨¸ë‹ˆì—ëŠ” ${state.inv.length>0 ? state.inv[0] : 'ë¬´ì–¸ê°€'}ê°€ ë‚¨ì•„ìˆì—ˆë‹¤.

[ìƒˆë²½ ì—”ë”© - ì‹œê°„ ì´ˆê³¼]`);
  setChoices([{text:'ë‹¤ì‹œ ì‹œì‘', fn:()=>location.reload()}]);
}

function endingMadness(){
  setText(`ì •ì‹ ì´ ë¬´ë„ˆì¡Œë‹¤.

í˜„ì‹¤ê³¼ í™˜ìƒì˜ ê²½ê³„ê°€ ì‚¬ë¼ì¡Œë‹¤.
ë‚˜ëŠ” ë” ì´ìƒ ëˆ„êµ¬ì¸ì§€ ëª¨ë¥¸ë‹¤.
${state.char}ì˜€ëŠ”ì§€, ì•„ë‹ˆë©´ ë‹¤ë¥¸ ëˆ„êµ°ê°€ì˜€ëŠ”ì§€.

ë¶‰ì€ ë“±ë¶ˆë§Œì´ ì˜ì›íˆ ê¹œë¹¡ì¸ë‹¤.
ì˜ì›íˆ.
ì˜ì›íˆ.

[ê´‘ê¸° ì—”ë”© - ì •ì‹ ë ¥ ì†Œì§„]`);
  setChoices([{text:'ë‹¤ì‹œ ì‹œì‘', fn:()=>location.reload()}]);
}

function endingGiveUp(){
  setText(`ì¶©ë¶„í•˜ë‹¤.

ë‚˜ëŠ” ë’¤ëŒì•„ì„°ë‹¤.
ê·€ì‹œì¥ì˜ ìœ í˜¹ì„ ë¿Œë¦¬ì¹˜ê³  í˜„ì‹¤ë¡œ ëŒì•„ì™”ë‹¤.

ë•Œë¡œëŠ” ëª¨ë¥´ëŠ” ì±„ë¡œ ë‚¨ê²¨ë‘ëŠ” ê²ƒì´
ë” ë‚˜ì€ ì„ íƒì¼ ìˆ˜ë„ ìˆë‹¤.

ìˆ˜ì§‘í•œ ë‹¨ì„œ: ${state.res.clues}
íŒíŠ¸ ì¡°ê°: ${state.meta.shards}

[í¬ê¸° ì—”ë”©]`);
  setChoices([{text:'ë‹¤ì‹œ ì‹œì‘', fn:()=>location.reload()}]);
}

/* ---------- HELP ---------- */
function showHelp(){ $('#help').classList.add('on'); }
function hideHelp(){ $('#help').classList.remove('on'); }

/* ---------- MISC ---------- */
function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((p,q)=>p[0]-q[0]).map(x=>x[1]); }
function msg(t){ 
  const s=$('#story'); 
  s.textContent += `\n\n${t}`;
}

/* ---------- INIT ---------- */
// ë‹¨ìˆœí•˜ê²Œ onclick ì‚¬ìš©
$('#btnEnter').onclick = startPrologue;
$('#btnHelp').onclick = showHelp;
$('#btnHelp2').onclick = showHelp;
$('#btnHelpClose').onclick = hideHelp;

// ìµœì´ˆ í‘œì‹œ
updateHUD();

</script>
</body>
</html>