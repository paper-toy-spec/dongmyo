<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>동묘 귀시장 · v1.0</title>
<style>
:root{
  --bg:#0b0b0c;--panel:#121213;--ink:#e8e0d8;--muted:#a89f96;--accent:#8b0000;--line:#2a2a2a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1100px circle at 50% -180px,#1a0000 0%,#0b0b0c 45%,#000 100%);
  color:var(--ink);font-family:"Noto Serif KR",Pretendard,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
.wrap{max-width:960px;margin:0 auto;padding:16px}
h1{margin:0 0 6px}
.btn, .choice{background:linear-gradient(180deg,#191919,#101010);border:1px solid #2b2b2b;color:var(--ink);
  padding:12px 14px;border-radius:10px;cursor:pointer;display:inline-block;
  -webkit-tap-highlight-color:transparent;
  user-select:none}
.btn:active,.choice:active{border-color:#922;background:linear-gradient(180deg,#3a0000,#260000)}
.title{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
.game-title{font-size:40px;color:#e35;text-shadow:0 0 26px rgba(139,0,0,.55)}
.intro{white-space:pre-wrap;color:var(--muted);line-height:1.85;max-width:760px;margin:12px auto 18px}
.panel{background:linear-gradient(180deg,#171717,#0e0e0f);border:1px solid var(--line);border-radius:12px;padding:16px}
.story{min-height:220px;white-space:pre-wrap;line-height:1.9;overflow-y:auto;max-height:50vh}
.choices{margin-top:12px;display:grid;gap:10px}
.hud{display:none}
.hud.on{display:block}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.h-title{font-weight:800;color:#e66}
.statbar{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin:10px 0}
.slab{background:linear-gradient(180deg,#171717,#101012);border:1px solid #2a2a2a;border-radius:10px;padding:8px 10px;text-align:center;font-size:13px}
.slab .v{display:block;font-weight:800;margin-top:4px}
.bad{color:#f59}
.good{color:#9ef0b0}
.warn{color:#f6d37a}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
.inv{margin-top:10px;padding:10px;border:1px dashed #333;border-radius:10px;display:none}
.inv.on{display:block}
.tag{background:#151515;border:1px solid #333;padding:4px 8px;border-radius:999px;font-size:12px;margin:2px}
.kv{font-size:12px;color:#b9b0a6}
hr.sep{border:none;border-top:1px solid #272727;margin:10px 0}
.help{position:fixed;right:0;top:0;bottom:0;width:380px;max-width:94vw;background:#111;border-left:1px solid #2a2a2a;transform:translateX(100%);transition:.25s;z-index:50;overflow-y:auto}
.help.on{transform:translateX(0)}
.help .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #2a2a2a}
.help .body{padding:12px;height:calc(100% - 52px);overflow:auto}
.small{font-size:12px;color:#9a8f85}
.prob{font-size:12px;color:#caa}
.tip{font-size:12px;color:#9ab1ff}
.notice{font-size:12px;color:#b7f59e}
@media (max-width:640px){
  .statbar{grid-template-columns:repeat(3,1fr)}
  .game-title{font-size:30px}
  .wrap{padding:10px}
  .btn, .choice{padding:14px 16px;font-size:14px}
}
</style>
</head>
<body>
<div class="wrap">

  <!-- TITLE -->
  <section class="title" id="title">
    <div>
      <div class="game-title">동묘 귀시장</div>
      <div class="intro" id="introText">
음력 초하루, 상망(上望).

골목길은 낮 동안의 흔적들로 어지럽다. 술에 취한 웃음소리, 택시 불빛, 골동품점 창가의 희미한 네온사인.
상인들은 가게 문을 닫고, 버스는 마지막 승객을 내려주고, 도로 위엔 간간이 자동차 소리만 남았다.
평범한 동네, 평범한 밤.

비리형사가 동묘 사당 앞에서 담배를 피우고 있다.
연기가 하늘로 올라갔다.

김정호가 있었다. 제임스도 있었다. 광고대행사 사장도.

아무도 먼저 오자고 하지 않았는데.

"또 왔네."

제임스가 웃었다. 씁쓸한 웃음이었다.

"뭘 기대하는 거지?"

김정호가 물었다.

"모르겠어."

제임스가 답했다.

벽을 바라봤다. 여전히 그냥 벽이었다.

하지만 가끔, 정말 가끔.
바람이 불면.
무언가 열리는 것 같은 기분이 들었다.

착각이었다.
분명 착각이었다.

그런데도 그들은 매일 밤 왔다.
기다렸다.
무엇을 기다리는지도 모른 채.

어디선가 방울 소리가 들렸다.
고양이 목에 달린 방울이었다. 길고양이가 지나갔다.
그뿐이었다.
      </div>

      <div class="row">
        <button class="btn" id="btnEnter">벽을 바라본다</button>
        <button class="btn" id="btnHelp">도움말</button>
      </div>
    </div>
  </section>

  <!-- HUD -->
  <section class="hud" id="hud">
    <div class="header">
      <div>
        <div class="h-title">동묘 귀시장</div>
        <div class="small" id="subinfo"></div>
      </div>
      <div class="row">
        <button class="btn" id="btnHelp2">도움말</button>
      </div>
    </div>

    <!-- Stats / Resources -->
    <div class="statbar">
      <div class="slab">이성<div class="v" id="sReason">3</div></div>
      <div class="slab">감정<div class="v" id="sEmp">3</div></div>
      <div class="slab">직관<div class="v" id="sInst">3</div></div>
      <div class="slab">시간<div class="v" id="rTime">60</div></div>
      <div class="slab">정신<div class="v" id="rPsy">70</div></div>
      <div class="slab">단서<div class="v" id="rClue">0</div></div>
    </div>
    <div class="row kv">
      <span>주화: <b id="rCoin">3</b></span>
      <span>의심도(Heat): <b id="rHeat">0</b></span>
      <span>힌트 조각: <b id="rShard">0</b></span>
      <span>동행 도움 쿨타임: <b id="rCD">0</b>턴</span>
    </div>

    <div class="panel">
      <div class="story" id="story">…</div>
      <div class="choices" id="choices"></div>
    </div>

    <div class="inv" id="inv">
      <div class="small" style="margin-bottom:6px">소지품</div>
      <div id="tags"></div>
    </div>
  </section>

  <!-- HELP -->
  <aside class="help" id="help">
    <div class="head">
      <div style="font-weight:800;color:#e6dbd0">도움말 / 규칙 / 튜토리얼</div>
      <button class="btn" id="btnHelpClose">닫기</button>
    </div>
    <div class="body">
      <h3 style="margin:6px 0 8px;color:#e66">핵심 규칙</h3>
      <p class="small">
        • 목표: 이름 없는 진실에 닿아 지하로 내려가고, 마지막에 선택하라.<br>
        • 상점은 한 번 거래하면 잠깁니다. (첫 거래 후 재입장 불가)<br>
        • 골목에서 NPC·전투·도박·교환으로 <b>힌트 조각</b>과 단서를 모으세요.<br>
        • <b>힌트 조각 ≥ 3</b> 또는 <b>단서 ≥ 4</b>면 바닥 문양이 반응 → 지하로 하강.<br>
        • 시간(60)은 매 행동에 소모, 0이면 새벽 엔딩. 정신 0이면 광기 엔딩.<br>
        • 버튼에 <span class="tip">성공률 %</span>이 보입니다. 동행 호출/아이템으로 보정 가능.
      </p>
      <hr class="sep">
      <h4>능력치</h4>
      <p class="small">
        • <b>이성</b>: 수수께끼/분석/해독 성공률↑<br>
        • <b>감정</b>: 설득/교섭/교환/특정 상점 호감 보정↑<br>
        • <b>직관</b>: 전투/도박/위험회피/행운 보정↑
      </p>
      <h4>동행(쿨 2턴)</h4>
      <p class="small">
        • 형사: 전투 +10% (정신 -5), 제임스: 도박 +10% (주화 -1),<br>
        • 광고사장: 교섭/수수께끼 힌트 (감정≥4 필요), 김정호: 가격 -1 (상점 1회)
      </p>
      <h4>의심도(Heat)</h4>
      <p class="small">
        • 실패/무리한 행동 시 +1. 3/6에 매복·가격인상 등 리스크 증가.
      </p>
      <h4>시간대 상점</h4>
      <p class="small">
        • 초기엔 2~3곳, 중반 3~4곳, 끝자락 1곳 등 가변. 함정 상점 등장 가능.
      </p>
      <p class="small notice">도움말엔 '누구'의 이름이 없습니다. 모든 건 직접 밝혀야 합니다.</p>
    </div>
  </aside>

</div>

<script>
/* ---------- UTIL ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function rnd(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* ---------- STATE ---------- */
const state = {
  scene: 'title',
  floor: 'G',
  char: null,
  stats: { reason:3, empathy:3, instinct:3 },
  res: { time:60, psyche:70, clues:0, coins:3 },
  meta: { heat:0, shards:0, turn:0, cd:0, pity:{fight:0,gamble:0,riddle:0} },
  inv: [],
  visitedShops: new Set(),
  lockedShops: new Set(),
  flags: { 
    marketSeen:false, 
    riddleHint:false,
    exploredAreas: {}
  },
};

/* ---------- DATA: SHOPS ---------- */
const SHOPS = [
  {
    id:'jewel',
    name:'영혼의 보석상',
    type:'riddle',
    openAt:'any',
    intro: `유리 진열장에 감정이 굳어 앉아 있었다. 파란빛은 오래된 울음, 붉은빛은 입술의 흉터, 초록빛은 말라붙은 그리움.
상인은 웃는지 아닌지 알 수 없는 목소리로 말했다. 
"원하는 건 알죠. 가진 걸 모를 뿐."`,
    riddle: {
      q:`"한 왕이 있었습니다. 
모든 슬픔을 팔아 왕국을 지켰고, 모든 분노를 팔아 평화를 샀으며, 모든 그리움을 팔아 미래를 얻었습니다.
그는 왜 무너졌을까요?"`,
      a:[
        { key:'인간성의 상실', text:'감정 없는 왕은 더 이상 인간이 아니었다', effect:()=>{ gain('clues',2); pushInv('지혜의 조각'); msg('상인은 고개를 끄덕였다. "껍데기는 오래 못 갑니다." (단서+2)'); } , pref:true },
        { key:'백성의 이탈', text:'백성들이 감정 없는 왕을 따르지 않았다', effect:()=>{ gain('clues',1); msg('"반쯤은요."(단서+1)'); } },
        { key:'기억의 잔존', text:'감정을 팔아도 기억은 남았다', effect:()=>{ state.stats.reason++; msg('"흥미로운 관찰." (이성+1)'); } }
      ]
    },
    items:[
      {name:'슬픔의 사파이어', cost:{coins:2, psyche:10,time:6}, lore:'울지 못하는 평온. 단, 오래 보면 차갑다.', effect:()=>{ pushInv('슬픔의 사파이어'); state.flags.riddleHint=true; }},
      {name:'분노의 루비', cost:{coins:2, psyche:5,time:6}, lore:'불로 쥔 정의. 단, 손바닥이 탄다.', effect:()=>{ pushInv('분노의 루비'); }},
      {name:'그리움의 에메랄드', cost:{coins:1, psyche:8,time:6}, lore:'뒤돌아보지 않게 해준다. 대신 내일이 흐릿해진다.', effect:()=>{ pushInv('그리움의 에메랄드'); }},
      {name:'후회의 다이아몬드', cost:{coins:3, psyche:12,time:8}, lore:'결정을 되짚게 한다. 단, 되돌릴 수 없는 것만 선명해진다.', effect:()=>{ pushInv('후회의 다이아몬드'); }}
    ],
  },
  { id:'memory', name:'기억염색소', type:'trade', openAt:'any',
    intro:`허연 눈동자의 노파. 비단주머니 셋을 꺼내며 중얼거렸다. "잊은 줄 알았던 것, 잊고 싶었던 것, 잊어야 했던 것."`,
    items:[
      {name:'첫사랑의 마지막 인사', cost:{coins:1,time:5,psyche:6}, lore:'따뜻하지만 오래 보관하면 흐려진다.', effect:()=>{ pushInv('첫사랑의 마지막 인사'); addShard(1); gain('clues',1); }},
      {name:'깨끗했던 마음', cost:{coins:2,time:6,psyche:8}, lore:'잠깐의 용기. 다음 선택이 무거워진다.', effect:()=>{ pushInv('깨끗했던 마음'); addShard(1); gain('clues',1); }},
      {name:'희미한 이름 쪽지', cost:{coins:1,time:5}, lore:'물에 번진 필기체. 자음 하나가 남는다.', effect:()=>{ pushInv('쪽지(자음)'); addShard(1); }}
    ]
  },
  { id:'reassemble', name:'과거 재조립점', type:'trade', openAt:'any',
    intro:`나무상 위에 분해된 회중시계. 주인은 태엽을 들어 보이며 말했다. "빠진 건 늘 제일 작은 거지."`,
    items:[
      {name:'태엽 조각', cost:{coins:1,time:5}, lore:'아무것도 하지 않는 조각. 그러나 없는 것보단 낫다.', effect:()=>{ pushInv('태엽 조각'); addShard(1);} },
      {name:'낡은 나사못', cost:{coins:1,time:4}, lore:'구멍이 헐거운 기억에 박는다.', effect:()=>{ pushInv('낡은 나사못'); }},
      {name:'미세한 스프링', cost:{coins:1,time:4}, lore:'팽팽할수록 잘 끊어진다.', effect:()=>{ pushInv('미세한 스프링'); }}
    ]
  },
  { id:'desire', name:'욕망 매입소', type:'trade', openAt:'mid',
    intro:`붉은 향이 코를 찔렀다. "무엇을 잃고 싶으신가요?"`,
    items:[
      {name:'가벼운 양심', cost:{psyche:10,time:6}, lore:'죄책감이 덜 무겁다. 대신 의심이 빨리 붙는다.', effect:()=>{ pushInv('가벼운 양심'); state.meta.heat++; }},
      {name:'돈 냄새', cost:{coins:1,time:4}, lore:'전부가 그 냄새로 보인다.', effect:()=>{ pushInv('돈 냄새'); }}
    ]
  },
  { id:'post', name:'망자의 우체국', type:'trade', openAt:'late',
    intro:`공중에 편지들이 떠다녔다. 우체국장은 이미 오래전에 죽은 듯했다. "누구에게 보낼까요?"`,
    items:[
      {name:'사죄의 편지', cost:{time:6,psyche:8}, lore:'답은 오지 않는다. 마음은 가벼워진다.', effect:()=>{ pushInv('사죄의 편지'); gain('clues',1);} },
      {name:'질문의 편지', cost:{time:6,coins:1}, lore:'가끔 답장이 온다. 대개는 늦다.', effect:()=>{ pushInv('질문의 편지'); if(Math.random()<0.4){ addShard(1); msg('느린 답장: 힌트 조각 +1'); }} }
    ]
  }
];

/* ---------- EXPLORATION DATA ---------- */
function alley(){
  state.scene='alley';
  setText(`시장을 떠나 골목을 탐험한다.

붉은 등롱 사이로 이어진 좁은 길들.
어둠 속에서 무언가 반짝이는 것들이 보인다.
발걸음 하나하나가 과거의 흔적을 밟는 듯하다.

어느 길로 향할까?`);
  
  const exploredCount = Object.keys(state.flags.exploredAreas || {}).length;
  const choices = [];
  
  // 기본 탐험 지역들
  choices.push({text:'🌅 동쪽 골목 - 1956년의 기억', fn:()=>exploreEast()});
  choices.push({text:'🌆 서쪽 뒷골목 - 리먼의 그림자', fn:()=>exploreWest()});
  choices.push({text:'🌙 북쪽 광장 - 시궁창쥐의 소굴', fn:()=>exploreNorth()});
  choices.push({text:'🏚️ 남쪽 창고 - 뇌물의 증거', fn:()=>exploreSouth()});
  
  // 특별 지역 (조건부 개방)
  if (exploredCount >= 2) {
    choices.push({text:'🏗️ 옥상 - 부서진 간판들', fn:()=>exploreRoof()});
  }
  if (exploredCount >= 3) {
    choices.push({text:'🕳️ 지하 통로 - 숨겨진 방', fn:()=>exploreBasement()});
  }
  
  // 랜덤 이벤트
  if (Math.random() < 0.3) {
    choices.push({text:'👤 수상한 인물과 조우', fn:()=>npcEncounter()});
  }
  if (Math.random() < 0.3) {
    choices.push({text:'⚔️ 그림자와 대치', fn:()=>lightFight()});
  }
  if (Math.random() < 0.3) {
    choices.push({text:'🎲 도박판 발견', fn:()=>gambling()});
  }
  
  choices.push({text:'🛍️ 상점가로 돌아간다', fn:openMarket});
  
  setChoices(choices);
}

function exploreEast(){
  if (!state.flags.exploredAreas) state.flags.exploredAreas = {};
  
  if (state.flags.exploredAreas.east) {
    setText(`동쪽 골목 - 이미 탐험한 곳

여전히 1956년의 기억이 남아있다.
헤어진 옷감 조각이 바람에 날린다.
더 이상 새로운 발견은 없을 것 같다.`);
    setChoices([
      {text:'다른 곳을 탐험한다', fn:alley},
      {text:'상점가로 돌아간다', fn:openMarket}
    ]);
    return;
  }
  
  const isRelevant = (state.char === '김정호');
  spend({time:6});
  
  setText(`동쪽 골목 - 1956년의 기억

좁은 골목 끝에 낡은 기차역 간판이 보인다.
"서울역 ← 2km"
페인트가 벗겨져 겨우 알아볼 수 있다.

바닥에는 작은 옷감 조각이 흩어져 있다.
어린아이 것으로 보이는 분홍색 리본.
68년이 흘렀지만 아직도 선명하다.

벽에는 누군가 긁어놓은 글씨가 있다.
"오빠... 고마워..."

${isRelevant ? '당신의 가슴이 아프게 조여온다. 이곳에서 무슨 일이...' : '누군가의 아픈 기억이 서려있는 곳 같다.'}`);
  
  // 캐릭터별 차등 보상
  if (isRelevant) {
    gain('clues', 2);
    losePsy(8);
    pushInv('분홍색 리본');
    msg('깊은 기억이 되살아났다. (단서+2, 정신-8)');
  } else {
    gain('clues', 1);
    losePsy(3);
    msg('오래된 슬픔이 느껴진다. (단서+1, 정신-3)');
  }
  
  state.flags.exploredAreas.east = true;
  
  setChoices([
    {text:'더 깊이 들어가 본다', fn:()=>deepExploreEast()},
    {text:'다른 곳을 탐험한다', fn:alley},
    {text:'상점가로 돌아간다', fn:openMarket}
  ]);
}

function deepExploreEast(){
  spend({time:4, psyche:5});
  
  setText(`동쪽 골목 깊숙이

더 안쪽으로 들어가자 작은 방이 나타났다.
벽에는 낡은 사진들이 붙어있다.
흑백사진 속 두 아이가 손을 잡고 웃고 있다.

사진 뒤에 쓰여진 글씨:
"1954년 겨울"

책상 위에는 펜으로 쓴 편지가 있다.
잉크가 번져 읽기 어렵지만...

"오빠, 나 미국 잘 도착했어.
여기 병원 정말 좋아. 곧 나을 것 같아.
오빠는 나를 버린 게 아니라 살려준 거라는 걸 알아.
사랑해..."

마지막 편지는 병원 편지지에 쓰여있다.
"오빠, 나 이제 떠날 것 같아. 평생 기다렸어.
한 번도 오빠를 원망한 적 없어.
제임스라는 아이를 입양했어. 
세 번이나 버려진 아이야. 내가 구해줬어."`);
  
  addShard(1);
  gain('clues', 1);
  msg('68년간의 편지를 발견했다. (힌트 조각+1, 단서+1)');
  
  setChoices([
    {text:'편지를 모두 가져간다', fn:()=>{ pushInv('68년간의 편지'); alley(); }},
    {text:'조용히 방을 나온다', fn:alley}
  ]);
}

function exploreWest(){
  if (!state.flags.exploredAreas) state.flags.exploredAreas = {};
  
  if (state.flags.exploredAreas.west) {
    setText(`서쪽 뒷골목 - 이미 탐험한 곳

숫자들의 잔향이 여전히 맴돌고 있다.
더 이상 새로운 발견은 없을 것 같다.`);
    setChoices([
      {text:'다른 곳을 탐험한다', fn:alley},
      {text:'상점가로 돌아간다', fn:openMarket}
    ]);
    return;
  }
  
  const isRelevant = (state.char === '제임스');
  spend({time:6});
  
  setText(`서쪽 뒷골목 - 리먼의 그림자

골목 벽에 숫자들이 새겨져 있다.
하지만 이상하다. 숫자들이 계속 변하고 있다.

처음에는 정확한 재무제표였지만,
지켜보고 있으면 서서히 왜곡되어간다.